<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Vehicular emissions inventory with VEIN</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Vehicular emissions inventory with VEIN" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="github-repo" content="ibarraespinosa/veinbook" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Vehicular emissions inventory with VEIN" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Sergio Ibarra-Espinosa">


<meta name="date" content="2018-12-02">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="est.html">
<link rel="next" href="he.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">veinbook</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#purpose"><i class="fa fa-check"></i>Purpose</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#structure"><i class="fa fa-check"></i>Structure</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-author"><i class="fa fa-check"></i>About the author</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#definitions-and-sources-of-information"><i class="fa fa-check"></i><b>1.1</b> Definitions and sources of information</a><ul>
<li class="chapter" data-level="1.1.1" data-path="intro.html"><a href="intro.html#approaches"><i class="fa fa-check"></i><b>1.1.1</b> Approaches</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#installation"><i class="fa fa-check"></i><b>1.2</b> Installation</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#required-r-packages-and-dependencies"><i class="fa fa-check"></i><b>1.3</b> Required R packages and dependencies</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#data-inside-the-vein-model"><i class="fa fa-check"></i><b>1.4</b> Data inside the VEIN model</a><ul>
<li class="chapter" data-level="1.4.1" data-path="intro.html"><a href="intro.html#emission-factors-from-cetesb"><i class="fa fa-check"></i><b>1.4.1</b> Emission factors from CETESB</a></li>
<li class="chapter" data-level="1.4.2" data-path="intro.html"><a href="intro.html#mileage-functions-of-brazilian-fleet"><i class="fa fa-check"></i><b>1.4.2</b> Mileage functions of Brazilian Fleet</a></li>
<li class="chapter" data-level="1.4.3" data-path="intro.html"><a href="intro.html#temporal-factors-for-passenger-cars"><i class="fa fa-check"></i><b>1.4.3</b> Temporal factors for Passenger Cars</a></li>
<li class="chapter" data-level="1.4.4" data-path="intro.html"><a href="intro.html#profile-for-cold-starts-of-passenger-cars"><i class="fa fa-check"></i><b>1.4.4</b> Profile for cold starts of Passenger Cars</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#acknowledgements"><i class="fa fa-check"></i><b>1.5</b> Acknowledgements</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="basic.html"><a href="basic.html"><i class="fa fa-check"></i><b>2</b> Basics of R</a><ul>
<li class="chapter" data-level="2.1" data-path="basic.html"><a href="basic.html#brief-history"><i class="fa fa-check"></i><b>2.1</b> Brief history</a><ul>
<li class="chapter" data-level="2.1.1" data-path="basic.html"><a href="basic.html#installation-1"><i class="fa fa-check"></i><b>2.1.1</b> Installation</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="basic.html"><a href="basic.html#using-r"><i class="fa fa-check"></i><b>2.2</b> Using R</a><ul>
<li class="chapter" data-level="2.2.1" data-path="basic.html"><a href="basic.html#r-objects"><i class="fa fa-check"></i><b>2.2.1</b> R objects</a></li>
<li class="chapter" data-level="2.2.2" data-path="basic.html"><a href="basic.html#factors"><i class="fa fa-check"></i><b>2.2.2</b> Factors</a></li>
<li class="chapter" data-level="2.2.3" data-path="basic.html"><a href="basic.html#missing-values"><i class="fa fa-check"></i><b>2.2.3</b> Missing Values</a></li>
<li class="chapter" data-level="2.2.4" data-path="basic.html"><a href="basic.html#matrices"><i class="fa fa-check"></i><b>2.2.4</b> Matrices</a></li>
<li class="chapter" data-level="2.2.5" data-path="basic.html"><a href="basic.html#arrays"><i class="fa fa-check"></i><b>2.2.5</b> Arrays</a></li>
<li class="chapter" data-level="2.2.6" data-path="basic.html"><a href="basic.html#lists"><i class="fa fa-check"></i><b>2.2.6</b> Lists</a></li>
<li class="chapter" data-level="2.2.7" data-path="basic.html"><a href="basic.html#data-frames"><i class="fa fa-check"></i><b>2.2.7</b> Data-Frames</a></li>
<li class="chapter" data-level="2.2.8" data-path="basic.html"><a href="basic.html#names"><i class="fa fa-check"></i><b>2.2.8</b> Names</a></li>
<li class="chapter" data-level="2.2.9" data-path="basic.html"><a href="basic.html#subseting-your-data.frame"><i class="fa fa-check"></i><b>2.2.9</b> Subseting your data.frame</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="basic.html"><a href="basic.html#inputting-data-into-r"><i class="fa fa-check"></i><b>2.3</b> Inputting data into R</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="st.html"><a href="st.html"><i class="fa fa-check"></i><b>3</b> Structuring an Emissions Inventory</a><ul>
<li class="chapter" data-level="3.1" data-path="st.html"><a href="st.html#veinstructure"><i class="fa fa-check"></i><b>3.1</b> Overview of emissions inventorying using VEIN</a></li>
<li class="chapter" data-level="3.2" data-path="st.html"><a href="st.html#the-inventory-function"><i class="fa fa-check"></i><b>3.2</b> The <code>inventory</code> function</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="traffic.html"><a href="traffic.html"><i class="fa fa-check"></i><b>4</b> Traffic data</a><ul>
<li class="chapter" data-level="4.1" data-path="traffic.html"><a href="traffic.html#sources-of-traffic-data"><i class="fa fa-check"></i><b>4.1</b> Sources of traffic data</a><ul>
<li class="chapter" data-level="4.1.1" data-path="traffic.html"><a href="traffic.html#outputs-from-travel-demand-models"><i class="fa fa-check"></i><b>4.1.1</b> Outputs from travel demand models</a></li>
<li class="chapter" data-level="4.1.2" data-path="traffic.html"><a href="traffic.html#interpolation-of-traffic-counts"><i class="fa fa-check"></i><b>4.1.2</b> Interpolation of traffic counts</a></li>
<li class="chapter" data-level="4.1.3" data-path="traffic.html"><a href="traffic.html#generating-traffic-flows-from-origin-destination-surveys-ods"><i class="fa fa-check"></i><b>4.1.3</b> Generating traffic flows from Origin-Destination-Surveys (ODS)</a></li>
<li class="chapter" data-level="4.1.4" data-path="traffic.html"><a href="traffic.html#top-down-approach"><i class="fa fa-check"></i><b>4.1.4</b> Top-down approach</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="traffic.html"><a href="traffic.html#main-functions"><i class="fa fa-check"></i><b>4.2</b> Main functions</a><ul>
<li class="chapter" data-level="4.2.1" data-path="traffic.html"><a href="traffic.html#expanding-traffic-data-with-the-function-temp_fact"><i class="fa fa-check"></i><b>4.2.1</b> Expanding traffic data with the function <code>temp_fact</code></a></li>
<li class="chapter" data-level="4.2.2" data-path="traffic.html"><a href="traffic.html#calculating-speed-at-other-hours-with-the-function-netspeed"><i class="fa fa-check"></i><b>4.2.2</b> Calculating speed at other hours with the function <code>netspeed</code></a></li>
<li class="chapter" data-level="4.2.3" data-path="traffic.html"><a href="traffic.html#distribution-of-vehicles-by-age-of-use-with-the-functions-age_ldv-age_hdv-and-age_moto"><i class="fa fa-check"></i><b>4.2.3</b> Distribution of vehicles by age of use with the functions <code>age_ldv</code>, <code>age_hdv</code> and <code>age_moto</code></a></li>
<li class="chapter" data-level="4.2.4" data-path="traffic.html"><a href="traffic.html#the-function-my_age"><i class="fa fa-check"></i><b>4.2.4</b> The function <code>my_age</code></a></li>
<li class="chapter" data-level="4.2.5" data-path="traffic.html"><a href="traffic.html#the-class-vehicles"><i class="fa fa-check"></i><b>4.2.5</b> The class <code>Vehicles</code></a></li>
<li class="chapter" data-level="4.2.6" data-path="traffic.html"><a href="traffic.html#other-traffic-functions"><i class="fa fa-check"></i><b>4.2.6</b> Other traffic functions</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="traffic.html"><a href="traffic.html#vehicular-composition"><i class="fa fa-check"></i><b>4.3</b> Vehicular composition</a></li>
<li class="chapter" data-level="4.4" data-path="traffic.html"><a href="traffic.html#application"><i class="fa fa-check"></i><b>4.4</b> Application</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="ef.html"><a href="ef.html"><i class="fa fa-check"></i><b>5</b> Emission Factors</a><ul>
<li class="chapter" data-level="5.1" data-path="ef.html"><a href="ef.html#speedef"><i class="fa fa-check"></i><b>5.1</b> Speed functions <code>ef_ldv_speed</code> and <code>ef_hdv_speed</code></a><ul>
<li class="chapter" data-level="5.1.1" data-path="ef.html"><a href="ef.html#emission-factors-of-ldv-depending-on-the-speed-with-the-function-ef_ldv_speed"><i class="fa fa-check"></i><b>5.1.1</b> Emission factors of LDV depending on the speed with the function <code>ef_ldv_speed</code></a></li>
<li class="chapter" data-level="5.1.2" data-path="ef.html"><a href="ef.html#emission-factors-of-hdv-depending-on-the-speed-with-the-function-ef_hdv_speed"><i class="fa fa-check"></i><b>5.1.2</b> Emission factors of HDV depending on the speed with the function <code>ef_hdv_speed</code></a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="ef.html"><a href="ef.html#localef"><i class="fa fa-check"></i><b>5.2</b> Local emission factors by age of use. The functions <code>EmissionFactors</code> and <code>EmissionFactorsList</code></a></li>
<li class="chapter" data-level="5.3" data-path="ef.html"><a href="ef.html#scale"><i class="fa fa-check"></i><b>5.3</b> Incorporating speed variation with the functions <code>ef_ldv_scaled</code> and <code>ef_hdv_scaled</code></a></li>
<li class="chapter" data-level="5.4" data-path="ef.html"><a href="ef.html#cold-starts"><i class="fa fa-check"></i><b>5.4</b> Cold Starts</a></li>
<li class="chapter" data-level="5.5" data-path="ef.html"><a href="ef.html#det"><i class="fa fa-check"></i><b>5.5</b> Deterioration</a></li>
<li class="chapter" data-level="5.6" data-path="ef.html"><a href="ef.html#evaporative-emissions-ef_evap"><i class="fa fa-check"></i><b>5.6</b> Evaporative emissions <code>ef_evap</code></a></li>
<li class="chapter" data-level="5.7" data-path="ef.html"><a href="ef.html#emission-factors-of-wear-ef_wear"><i class="fa fa-check"></i><b>5.7</b> Emission factors of wear <code>ef_wear</code></a></li>
<li class="chapter" data-level="5.8" data-path="ef.html"><a href="ef.html#emission-factors-from-tunnel-studies"><i class="fa fa-check"></i><b>5.8</b> Emission factors from tunnel studies</a></li>
<li class="chapter" data-level="5.9" data-path="ef.html"><a href="ef.html#emission-factors-from-international-vehicle-emissions-ive"><i class="fa fa-check"></i><b>5.9</b> Emission factors from International Vehicle Emissions (IVE)</a></li>
<li class="chapter" data-level="5.10" data-path="ef.html"><a href="ef.html#emission-factors-from-the-environmental-agency-of-sao-paulo"><i class="fa fa-check"></i><b>5.10</b> Emission factors from the Environmental Agency of São Paulo</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="est.html"><a href="est.html"><i class="fa fa-check"></i><b>6</b> Estimation of emissions</a><ul>
<li class="chapter" data-level="6.1" data-path="est.html"><a href="est.html#the-emis-function"><i class="fa fa-check"></i><b>6.1</b> The <code>emis</code> function</a></li>
<li class="chapter" data-level="6.2" data-path="est.html"><a href="est.html#the-emis_cold-function"><i class="fa fa-check"></i><b>6.2</b> The <code>emis_cold</code> function</a></li>
<li class="chapter" data-level="6.3" data-path="est.html"><a href="est.html#the-emis_evap-function"><i class="fa fa-check"></i><b>6.3</b> The <code>emis_evap</code> function</a></li>
<li class="chapter" data-level="6.4" data-path="est.html"><a href="est.html#the-emis_paved-function"><i class="fa fa-check"></i><b>6.4</b> The <code>emis_paved</code> function</a></li>
<li class="chapter" data-level="6.5" data-path="est.html"><a href="est.html#ew"><i class="fa fa-check"></i><b>6.5</b> The <code>emis_wear</code> function</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="post.html"><a href="post.html"><i class="fa fa-check"></i><b>7</b> Post estimation with <code>emis_post</code></a><ul>
<li class="chapter" data-level="7.1" data-path="post.html"><a href="post.html#emissions-by-street"><i class="fa fa-check"></i><b>7.1</b> Emissions by street</a></li>
<li class="chapter" data-level="7.2" data-path="post.html"><a href="post.html#total-emissions-in-data-frames"><i class="fa fa-check"></i><b>7.2</b> Total emissions in data-frames</a></li>
<li class="chapter" data-level="7.3" data-path="post.html"><a href="post.html#merging-emissions"><i class="fa fa-check"></i><b>7.3</b> Merging emissions</a></li>
<li class="chapter" data-level="7.4" data-path="post.html"><a href="post.html#creating-grids"><i class="fa fa-check"></i><b>7.4</b> Creating grids</a></li>
<li class="chapter" data-level="7.5" data-path="post.html"><a href="post.html#gridding-bottom-up-emissions-with-emis_grid"><i class="fa fa-check"></i><b>7.5</b> Gridding bottom-up emissions with <code>emis_grid</code></a></li>
<li class="chapter" data-level="7.6" data-path="post.html"><a href="post.html#gridding-top-down-emissions-with-emis_dist"><i class="fa fa-check"></i><b>7.6</b> Gridding top-down emissions with <code>emis_dist</code></a></li>
<li class="chapter" data-level="7.7" data-path="post.html"><a href="post.html#gridding-top-down-emissions-with-grid_emis"><i class="fa fa-check"></i><b>7.7</b> Gridding top-down emissions with <code>grid_emis</code></a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="he.html"><a href="he.html"><i class="fa fa-check"></i><b>8</b> Speciation</a><ul>
<li class="chapter" data-level="8.1" data-path="he.html"><a href="he.html#speed-functions-of-voc-species"><i class="fa fa-check"></i><b>8.1</b> Speed functions of VOC species</a></li>
<li class="chapter" data-level="8.2" data-path="he.html"><a href="he.html#speciate-function"><i class="fa fa-check"></i><b>8.2</b> Speciate function</a></li>
<li class="chapter" data-level="8.3" data-path="he.html"><a href="he.html#black-carbon-and-organic-matter"><i class="fa fa-check"></i><b>8.3</b> Black carbon and organic matter</a></li>
<li class="chapter" data-level="8.4" data-path="he.html"><a href="he.html#tyre-wear-breaks-wear-and-road-abrasion"><i class="fa fa-check"></i><b>8.4</b> Tyre wear, breaks wear and road abrasion</a></li>
<li class="chapter" data-level="8.5" data-path="he.html"><a href="he.html#no-and-no_2"><i class="fa fa-check"></i><b>8.5</b> <span class="math inline">\(NO\)</span> and <span class="math inline">\(NO_2\)</span></a></li>
<li class="chapter" data-level="8.6" data-path="he.html"><a href="he.html#volatile-organic-compounds-nmhc"><i class="fa fa-check"></i><b>8.6</b> Volatile organic compounds: <code>nmhc</code></a></li>
<li class="chapter" data-level="8.7" data-path="he.html"><a href="he.html#the-speciation-iag"><i class="fa fa-check"></i><b>8.7</b> The speciation <code>iag</code></a></li>
<li class="chapter" data-level="8.8" data-path="he.html"><a href="he.html#the-speciation-pmiag"><i class="fa fa-check"></i><b>8.8</b> The speciation <code>pmiag</code></a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="ep.html"><a href="ep.html"><i class="fa fa-check"></i><b>9</b> Inputs for atmospheric models</a><ul>
<li class="chapter" data-level="9.1" data-path="ep.html"><a href="ep.html#wrfchem-input-with-wrfinput-and-griddedemissionsarray"><i class="fa fa-check"></i><b>9.1</b> WRFChem input with wrfinput and <code>GriddedEmissionsArray</code></a><ul>
<li class="chapter" data-level="9.1.1" data-path="ep.html"><a href="ep.html#creating-a-wrf-chem-input-file"><i class="fa fa-check"></i><b>9.1.1</b> Creating a WRF-Chem input file</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="check.html"><a href="check.html"><i class="fa fa-check"></i><b>10</b> Quality check and errors</a><ul>
<li class="chapter" data-level="10.1" data-path="check.html"><a href="check.html#guidance-from-emepeea-air-pollutant-emission-inventory-guidebook"><i class="fa fa-check"></i><b>10.1</b> Guidance from EMEP/EEA air pollutant emission inventory guidebook</a><ul>
<li class="chapter" data-level="10.1.1" data-path="check.html"><a href="check.html#key-categories"><i class="fa fa-check"></i><b>10.1.1</b> Key categories</a></li>
<li class="chapter" data-level="10.1.2" data-path="check.html"><a href="check.html#uncertainty"><i class="fa fa-check"></i><b>10.1.2</b> Uncertainty</a></li>
<li class="chapter" data-level="10.1.3" data-path="check.html"><a href="check.html#quality-assurance-and-quality-check"><i class="fa fa-check"></i><b>10.1.3</b> Quality Assurance and Quality Check</a></li>
<li class="chapter" data-level="10.1.4" data-path="check.html"><a href="check.html#inventory-managment-cycle"><i class="fa fa-check"></i><b>10.1.4</b> Inventory managment cycle</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="check.html"><a href="check.html#avoiding-errors-with-vein"><i class="fa fa-check"></i><b>10.2</b> Avoiding errors with VEIN</a><ul>
<li class="chapter" data-level="10.2.1" data-path="check.html"><a href="check.html#traffic-flow"><i class="fa fa-check"></i><b>10.2.1</b> Traffic flow</a></li>
<li class="chapter" data-level="10.2.2" data-path="check.html"><a href="check.html#vehicular-composition-2"><i class="fa fa-check"></i><b>10.2.2</b> Vehicular composition</a></li>
<li class="chapter" data-level="10.2.3" data-path="check.html"><a href="check.html#units"><i class="fa fa-check"></i><b>10.2.3</b> Units</a></li>
<li class="chapter" data-level="10.2.4" data-path="check.html"><a href="check.html#emission-factors-1"><i class="fa fa-check"></i><b>10.2.4</b> Emission factors</a></li>
<li class="chapter" data-level="10.2.5" data-path="check.html"><a href="check.html#deterioration"><i class="fa fa-check"></i><b>10.2.5</b> Deterioration</a></li>
<li class="chapter" data-level="10.2.6" data-path="check.html"><a href="check.html#fuel-evaluation"><i class="fa fa-check"></i><b>10.2.6</b> Fuel evaluation</a></li>
<li class="chapter" data-level="10.2.7" data-path="check.html"><a href="check.html#fuel-quality"><i class="fa fa-check"></i><b>10.2.7</b> Fuel quality</a></li>
<li class="chapter" data-level="10.2.8" data-path="check.html"><a href="check.html#emissions-estimation"><i class="fa fa-check"></i><b>10.2.8</b> Emissions estimation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="" data-path="appendix-a-fast-example-of-vein.html"><a href="appendix-a-fast-example-of-vein.html"><i class="fa fa-check"></i>Appendix A: Fast Example of VEIN</a></li>
<li class="chapter" data-level="" data-path="appendix-b-detailed-example-of-vein.html"><a href="appendix-b-detailed-example-of-vein.html"><i class="fa fa-check"></i>Appendix B: Detailed Example of VEIN</a><ul>
<li class="chapter" data-level="A.3" data-path="appendix-b-detailed-example-of-vein.html"><a href="appendix-b-detailed-example-of-vein.html#network-1"><i class="fa fa-check"></i><b>A.3</b> Network</a></li>
<li class="chapter" data-level="A.4" data-path="appendix-b-detailed-example-of-vein.html"><a href="appendix-b-detailed-example-of-vein.html#vehicular-composition-cetesb2015"><i class="fa fa-check"></i><b>A.4</b> Vehicular composition <span class="citation">(CETESB <a href="#ref-CETESB2015">2015</a>)</span></a></li>
<li class="chapter" data-level="A.5" data-path="appendix-b-detailed-example-of-vein.html"><a href="appendix-b-detailed-example-of-vein.html#traffic-data"><i class="fa fa-check"></i><b>A.5</b> Traffic data</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="appendix-b.html"><a href="appendix-b.html"><i class="fa fa-check"></i>Appendix B</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="_blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Vehicular emissions inventory with VEIN</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="post" class="section level1">
<h1><span class="header-section-number">Chapter 7</span> Post estimation with <code>emis_post</code></h1>
<p>Once the emissions are estimated we obtained <code>EmissionsArray</code> objects, which as mentioned before, they are arrays with the dimensions streets x age distribution of vehicles x hours x days.</p>
<div class="figure" style="text-align: center"><span id="fig:demispost"></span>
<img src="figuras/dia7.png" alt="Post-emissions" width="100%" />
<p class="caption">
Figure 7.1: Post-emissions
</p>
</div>
<p>Now the function <code>emis_post</code> reads the <code>EmissionsArray</code> also, convert it to data-frames that are easier to manage.</p>
<p>The arguments of <code>emis_post</code> are:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">args</span>(vein<span class="op">::</span>emis_post)</code></pre></div>
<pre><code>## function (arra, veh, size, fuel, pollutant, by = &quot;veh&quot;, net) 
## NULL</code></pre>
<p>Where,</p>
<ul>
<li><code>arra</code>: <code>EmissionsArray</code> obtained with the <code>emis</code> functions. It is an array of emissions 4d: streets x category of vehicles x hours x days or 3d: streets x category of vehicles x hours.</li>
<li><code>veh</code>: Character indicating the type of vehicle, for instance: “PC”.</li>
<li><code>size</code>: Character indicating the size or weight, for instance: “&lt;1400”, “1400&lt;cc&lt;2000”, “GLP”, “Diesel”.</li>
<li><code>fuel</code>: Character indicating fuel, for instance: “Gasoline”, “E_25”, “GLP”, “Diesel”.</li>
<li><code>pollutant</code>: Character indicating the pollutant, for instance, “CO”, “NOx”, …</li>
<li><code>by</code>: Character indicating the type of output, “veh” for the total vehicular category, “streets_narrow” or “streets_wide”. “streets_wide” or just “streets” returns a dataframe with rows as the number of streets and columns the hours as days*hours considered, e.g., 168 columns as the hours of a whole week and “streets_wide repeats the row number of streets by the hour and day of the week</li>
</ul>
<p>Let’s create some objects</p>
<div id="emissions-by-street" class="section level2">
<h2><span class="header-section-number">7.1</span> Emissions by street</h2>
<p>From previous chapters, we worked with <code>Vehicles</code>, <code>EmissionFactors</code> and estimate emissions generating <code>EmissionsArray</code>. Now let’s create an <code>EmissionsArray</code> object.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(vein)
<span class="kw">library</span>(veinreport)</code></pre></div>
<pre><code>## 
## Attaching package: &#39;veinreport&#39;</code></pre>
<pre><code>## The following object is masked _by_ &#39;.GlobalEnv&#39;:
## 
##     theme_black</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(cptcity)
<span class="kw">library</span>(ggplot2)
<span class="kw">data</span>(net)
<span class="kw">data</span>(profiles)
<span class="kw">data</span>(fe2015)
PC_G &lt;-<span class="st"> </span><span class="kw">age_ldv</span>(<span class="dt">x =</span> net<span class="op">$</span>ldv, <span class="dt">name =</span> <span class="st">&quot;PC&quot;</span>)</code></pre></div>
<pre><code>## Average age of PC is 11.17</code></pre>
<pre><code>## Number of PC is 1946.95 * 10^3 veh</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Estimation for 168 hour and local factors</span>
pcw &lt;-<span class="st"> </span><span class="kw">temp_fact</span>(net<span class="op">$</span>ldv, profiles<span class="op">$</span>PC_JUNE_<span class="dv">2014</span>)
<span class="co"># June is not holliday in southern hemisphere</span>
hdvw &lt;-<span class="st"> </span><span class="kw">temp_fact</span>(net<span class="op">$</span>hdv, profiles<span class="op">$</span>HGV_JUNE_<span class="dv">2014</span>)
speed &lt;-<span class="st"> </span><span class="kw">netspeed</span>(pcw <span class="op">+</span><span class="st"> </span>hdvw, net<span class="op">$</span>ps, net<span class="op">$</span>ffs, net<span class="op">$</span>capacity, net<span class="op">$</span>lkm, <span class="dt">alpha =</span> <span class="dv">1</span>)
lef &lt;-<span class="st"> </span><span class="kw">EmissionFactorsList</span>(fe2015[fe2015<span class="op">$</span>Pollutant<span class="op">==</span><span class="st">&quot;CO&quot;</span>, <span class="st">&quot;PC_G&quot;</span>])
E_CO &lt;-<span class="st"> </span><span class="kw">emis</span>(<span class="dt">veh =</span> PC_G,<span class="dt">lkm =</span> net<span class="op">$</span>lkm, <span class="dt">ef =</span> lef, <span class="dt">speed =</span> speed,
             <span class="dt">profile =</span> profiles<span class="op">$</span>PC_JUNE_<span class="dv">2014</span>)</code></pre></div>
<pre><code>## 187546.38 kg emissions in 24 hours and 7 days</code></pre>
<p>Now that we have our <code>EmissionsArray</code> E_CO, we can process it with the function <code>emis_post</code>. The emissions by street are obtained with the argument <code>by</code> = “streets_wide”:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">E_CO_STREETS &lt;-<span class="st"> </span><span class="kw">emis_post</span>(E_CO, <span class="dt">by =</span> <span class="st">&quot;streets_wide&quot;</span>)
E_CO_STREETS[<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]</code></pre></div>
<pre><code>## Result for Emissions 
##                 V1               V2              V3
## 1 676.629408 [g/h] 349.068278 [g/h] 206.13032 [g/h]
## 2 259.924802 [g/h] 134.093349 [g/h]  79.18423 [g/h]
## 3  38.107534 [g/h]  19.659404 [g/h]  11.60919 [g/h]
## 4  90.628506 [g/h]  46.754599 [g/h]  27.60933 [g/h]
## 5   3.884417 [g/h]   2.003943 [g/h]   1.18336 [g/h]
## 6 378.775340 [g/h] 195.407492 [g/h] 115.39120 [g/h]</code></pre>
<p>In the version 0.3.17 it was added the capability of returning an spatial object class ‘sf’ with ‘LINESTRING’:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">E_CO_STREETS &lt;-<span class="st"> </span><span class="kw">emis_post</span>(E_CO, <span class="dt">by =</span> <span class="st">&quot;streets_wide&quot;</span>, <span class="dt">net =</span> net)
<span class="kw">class</span>(E_CO_STREETS)</code></pre></div>
<pre><code>## [1] &quot;sf&quot;         &quot;data.frame&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(E_CO_STREETS) <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> <span class="kw">as.numeric</span>(V9))) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_gradientn</span>(<span class="dt">colours =</span> <span class="kw">rev</span>(<span class="kw">cpt</span>())) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;CO emissions at 08:00 (g/h)&quot;</span>)</code></pre></div>
<div class="figure"><span id="fig:pcco"></span>
<img src="veinbook_files/figure-html/pcco-1.svg" alt="CO emisions of PC (g/h)" width="672" />
<p class="caption">
Figure 7.2: CO emisions of PC (g/h)
</p>
</div>
<p>Now, if we estimate the NOx emissions of Light Trucks we will a slight different pattern of emissions:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">LT &lt;-<span class="st"> </span><span class="kw">age_hdv</span>(<span class="dt">x =</span> net<span class="op">$</span>hdv, <span class="dt">name =</span> <span class="st">&quot;LT&quot;</span>)</code></pre></div>
<pre><code>## Average age of LT is 17.12</code></pre>
<pre><code>## Number of LT is 148.12 * 10^3 veh</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lef &lt;-<span class="st"> </span><span class="kw">EmissionFactorsList</span>(fe2015[fe2015<span class="op">$</span>Pollutant<span class="op">==</span><span class="st">&quot;NOx&quot;</span>, <span class="st">&quot;LT&quot;</span>])
E_NOx &lt;-<span class="st"> </span><span class="kw">emis</span>(<span class="dt">veh =</span> LT, <span class="dt">lkm =</span> net<span class="op">$</span>lkm, <span class="dt">ef =</span> lef, <span class="dt">speed =</span> speed,
              <span class="dt">profile =</span> profiles<span class="op">$</span>PC_JUNE_<span class="dv">2014</span>)</code></pre></div>
<pre><code>## 34029.87 kg emissions in 24 hours and 7 days</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">E_NOx_STREETS &lt;-<span class="st"> </span><span class="kw">emis_post</span>(E_NOx, <span class="dt">by =</span> <span class="st">&quot;streets_wide&quot;</span>, <span class="dt">net =</span> net)
<span class="kw">ggplot</span>(E_NOx_STREETS) <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> <span class="kw">as.numeric</span>(V9))) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_gradientn</span>(<span class="dt">colours =</span> <span class="kw">rev</span>(<span class="kw">cpt</span>())) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;NOX emissions at 08:00 (g/h)&quot;</span>)</code></pre></div>
<div class="figure"><span id="fig:ltnox"></span>
<img src="veinbook_files/figure-html/ltnox-1.svg" alt="NOx emisions of LT (g/h)" width="672" />
<p class="caption">
Figure 7.3: NOx emisions of LT (g/h)
</p>
</div>
</div>
<div id="total-emissions-in-data-frames" class="section level2">
<h2><span class="header-section-number">7.2</span> Total emissions in data-frames</h2>
<p>To obtain the total emissions in data-frame, the same function <code>emis_post</code> is used, but in this case, with the argument <code>by</code> = “veh”. We also need to add arguments of <code>veh</code> for the type of vehicle, <code>size</code> the size or gross weight, <code>fuel</code> and <code>pollutant</code>. The argument <code>net</code> is not required in this case.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">E_NOx_DF &lt;-<span class="st"> </span><span class="kw">emis_post</span>(<span class="dt">arra =</span> E_NOx, <span class="dt">veh =</span> <span class="st">&quot;LT&quot;</span>, <span class="dt">size =</span> <span class="st">&quot;Small&quot;</span>, <span class="dt">fuel =</span> <span class="st">&quot;B5&quot;</span>,
                      <span class="dt">by =</span> <span class="st">&quot;veh&quot;</span>, <span class="dt">pollutant =</span> <span class="st">&quot;NOx&quot;</span>)
<span class="kw">head</span>(E_NOx_DF)</code></pre></div>
<pre><code>##     E_NOx              g veh  size fuel pollutant age hour
## 1 E_NOx_1 182.5943 [g/h]  LT Small   B5       NOx   1    1
## 2 E_NOx_2 163.2499 [g/h]  LT Small   B5       NOx   2    1
## 3 E_NOx_3 177.5608 [g/h]  LT Small   B5       NOx   3    1
## 4 E_NOx_4 208.5892 [g/h]  LT Small   B5       NOx   4    1
## 5 E_NOx_5 765.7001 [g/h]  LT Small   B5       NOx   5    1
## 6 E_NOx_6 885.6223 [g/h]  LT Small   B5       NOx   6    1</code></pre>
<p>The resulting object is a data-frame with the name of the input array, and then it has the g/h. Also, the name of the vehicle, the size, fuel, pollutant, age and hour, which is interesting because we can know what the most pollutant vehicle is and at which hour these emissions occurred.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">E_NOx_DF[E_NOx_DF<span class="op">$</span>g <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(E_NOx_DF<span class="op">$</span>g), ]</code></pre></div>
<pre><code>##        E_NOx              g veh  size fuel pollutant age hour
## 517 E_NOx_17 29139.51 [g/h]  LT Small   B5       NOx  17   11</code></pre>
<p>The highest emissions by the hour are of Light Trucks of 17 years of use at hour 11 on local time. However, it is possible to get more interesting insights into the data. The data can be aggregated by age, hour or plot all together as shown in Fig. <a href="post.html#fig:noxlt3">7.6</a>. The highest emissions occurred between 17 and 27 years of use. This figure also shows the effect of emissions standards introduced in different years.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span><span class="kw">aggregate</span>(E_NOx_DF<span class="op">$</span>g, <span class="dt">by =</span> <span class="kw">list</span>(E_NOx_DF<span class="op">$</span>hour), sum)
<span class="kw">plot</span>(df, <span class="dt">type =</span> <span class="st">&quot;b&quot;</span>, <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">xlab =</span> <span class="st">&quot;hour&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;NOx (g/h)&quot;</span>)</code></pre></div>
<div class="figure"><span id="fig:noxlt1"></span>
<img src="veinbook_files/figure-html/noxlt1-1.svg" alt="NOx emissions of LT by hour" width="672" />
<p class="caption">
Figure 7.4: NOx emissions of LT by hour
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(veinreport) <span class="co"># theme_black</span>
df &lt;-<span class="st"> </span><span class="kw">aggregate</span>(E_NOx_DF<span class="op">$</span>g, <span class="dt">by =</span> <span class="kw">list</span>(E_NOx_DF<span class="op">$</span>age), sum)
<span class="kw">names</span>(df) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Age&quot;</span>, <span class="st">&quot;g&quot;</span>)
<span class="kw">ggplot</span>(df, <span class="kw">aes</span>(<span class="dt">x =</span> Age, <span class="dt">y =</span> <span class="kw">as.numeric</span>(g), <span class="dt">fill =</span> <span class="kw">as.numeric</span>(g))) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colours =</span> <span class="kw">cpt</span>()) <span class="op">+</span><span class="st"> </span><span class="kw">theme_black</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Age of use&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;NOx (g/h)&quot;</span>)</code></pre></div>
<div class="figure"><span id="fig:noxlt2"></span>
<img src="veinbook_files/figure-html/noxlt2-1.svg" alt="NOx emissions of LT by age" width="672" />
<p class="caption">
Figure 7.5: NOx emissions of LT by age
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(veinreport) <span class="co"># theme_black</span>
<span class="kw">ggplot</span>(E_NOx_DF, <span class="kw">aes</span>(<span class="dt">x =</span> age, <span class="dt">y =</span> <span class="kw">as.numeric</span>(g), <span class="dt">fill =</span> hour)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colours =</span> <span class="kw">cpt</span>()) <span class="op">+</span><span class="st"> </span><span class="kw">theme_black</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Age of use&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;NOx (g/h)&quot;</span>)</code></pre></div>
<div class="figure"><span id="fig:noxlt3"></span>
<img src="veinbook_files/figure-html/noxlt3-1.svg" alt="NOx emissions of LT" width="672" />
<p class="caption">
Figure 7.6: NOx emissions of LT
</p>
</div>
</div>
<div id="merging-emissions" class="section level2">
<h2><span class="header-section-number">7.3</span> Merging emissions</h2>
<p>The function <code>inventory</code> was designed to store the emissions of each type of vehicle in each directory. Hence, it was necessary to create a function that reads and merge the emissions that are in each directory, returning a data-frame os a spatial feature data-frame. The function is <code>emis_merge</code>. Fig. <a href="post.html#fig:demispost">7.1</a>, <code>emis_merge</code> comes after <code>emis_post</code> or <code>speciate</code>. The arguments of <code>emis_merge</code> are:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">args</span>(vein<span class="op">::</span>emis_merge)</code></pre></div>
<pre><code>## function (pol = &quot;CO&quot;, what = &quot;STREETS.rds&quot;, streets = T, net, 
##     path = &quot;emi&quot;, crs, under = &quot;after&quot;, ignore = FALSE, as_list = FALSE) 
## NULL</code></pre>
<p>Where,</p>
<ul>
<li><code>pol</code>: Character. Pollutant.</li>
<li><code>what</code>: Character. Word to search the emissions names, “STREETS”, “DF” or whatever name. It is important to include the extension .‘rds’</li>
<li><code>streets</code>: Logical. If true, emis_merge reads the street emissions created with emis_post by “streets_wide”, returning an object with class ‘sf’. If false, it reads the emissions data-frame and rbind them.</li>
<li><code>net</code>: ‘Spatial feature’ or ‘SpatialLinesDataFrame’ with the streets. It is expected that the number of rows is equal to the number of rows of street emissions. If not, the function stops.</li>
<li><code>path</code>: Character. A path where emissions are located</li>
<li><code>crs</code>: coordinate reference system in numeric format from <a href="http://spatialreference.org/" class="uri">http://spatialreference.org/</a> to transform/project spatial data using sf::st_transform</li>
</ul>
<p>To see how this functions works, let’s run the example in the <code>inventory</code> function. First, let’s create a project, or in other words, a directory named “YourCity”, into the temporary directory. Then run <code>inventory</code> with the default configuration.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">name =<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;YourCity&quot;</span>)
vein<span class="op">::</span><span class="kw">inventory</span>(<span class="dt">name =</span> name, <span class="dt">show.main =</span> <span class="ot">FALSE</span>)</code></pre></div>
<pre><code>## files at /tmp/Rtmpm9wSQ0/YourCity</code></pre>
<pre><code>## Directories:
##  [1] &quot;/tmp/Rtmpm9wSQ0/YourCity&quot;             
##  [2] &quot;/tmp/Rtmpm9wSQ0/YourCity/ef&quot;          
##  [3] &quot;/tmp/Rtmpm9wSQ0/YourCity/emi&quot;         
##  [4] &quot;/tmp/Rtmpm9wSQ0/YourCity/emi/BUS_01&quot;  
##  [5] &quot;/tmp/Rtmpm9wSQ0/YourCity/emi/HGV_01&quot;  
##  [6] &quot;/tmp/Rtmpm9wSQ0/YourCity/emi/LCV_01&quot;  
##  [7] &quot;/tmp/Rtmpm9wSQ0/YourCity/emi/MC_01&quot;   
##  [8] &quot;/tmp/Rtmpm9wSQ0/YourCity/emi/PC_01&quot;   
##  [9] &quot;/tmp/Rtmpm9wSQ0/YourCity/est&quot;         
## [10] &quot;/tmp/Rtmpm9wSQ0/YourCity/images&quot;      
## [11] &quot;/tmp/Rtmpm9wSQ0/YourCity/network&quot;     
## [12] &quot;/tmp/Rtmpm9wSQ0/YourCity/post&quot;        
## [13] &quot;/tmp/Rtmpm9wSQ0/YourCity/post/df&quot;     
## [14] &quot;/tmp/Rtmpm9wSQ0/YourCity/post/grids&quot;  
## [15] &quot;/tmp/Rtmpm9wSQ0/YourCity/post/streets&quot;
## [16] &quot;/tmp/Rtmpm9wSQ0/YourCity/profiles&quot;    
## [17] &quot;/tmp/Rtmpm9wSQ0/YourCity/veh&quot;</code></pre>
<p>In my case, the files are in directory /tmp/Rtmpm9wSQ0/YourCity. Now, if you open the file file main.R, you will see:</p>
<p><img src="figuras/main.png" width="70%" style="display: block; margin: auto;" /></p>
<p>This script starts with <code>setwd</code> function, Then the first section is the network, where the user reads and prepares the traffic information. Then the second section runs a script which runs the age functions for the default vehicular composition of the <code>inventory</code> function. The third section estimates the emissions by running each input.R file inside the directory <em>est</em> The fourth section, creates a grid and run the script post.R is shown below:</p>
<p><img src="figuras/post.png" width="70%" style="display: block; margin: auto;" /></p>
<p>The function <code>emis_merge</code> shown in line 2 is designed to read all the files with names CO and the default argument <code>what</code> is “STREETS.rds”, for instance, PC_GASOLINE_CO_STREETS.rds. Hence, this function reads all the files under that condition. The other argument is <code>streets</code> with default value of <code>TRUE</code>, meaning that the function now knows that the resulting object must be a spatial network, and the <code>net</code> argument is already calling the net object part of the VEIN data, the function merges all the objects summing the emissions of all vehicle street by street. The resulting object is a spatial “LINESTRING” class of <code>sf</code>. This function assumes that emissions files are data.frames and no tests have been made to see if this function would read work <code>sf</code> objects.</p>
<p>On the other hand, the line 12 also runs all the emissions files whose names include the word CO, but also including the words “DF.rds”, which are the files from <code>emis_post</code> with argument <code>by</code> equals to “veh”. In this case, it reads and merges the data-frames and prints the sum emissions by pollutant.</p>
<p>Sourcing the file main.R runs each line of this script, estimating emissions and producing some plots.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">source</span>(<span class="kw">paste0</span>(name, <span class="st">&quot;/main.R&quot;</span>))</code></pre></div>
</div>
<div id="creating-grids" class="section level2">
<h2><span class="header-section-number">7.4</span> Creating grids</h2>
<p>Once we have processed our emissions array with <code>emis_post</code> and we have spatial emissions, we can then create grids and allocate our emissions into the grids. Let’s check the function <code>make_grid</code> first:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">args</span>(vein<span class="op">::</span>make_grid)</code></pre></div>
<pre><code>## function (spobj, width, height = width, polygon, crs = 4326, 
##     ...) 
## NULL</code></pre>
<p>This function initially used an <code>sp</code> approach. However, now uses an <code>sf</code> approach for creating the grid. The arguments are pretty much the same with the <code>sf::st_make_grid</code> with the exception that is focused in returning polygons with coordinates at centroids of each cell. Therefore, the arguments height and polygon are deprecated. Let’s create a grid for our net.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(vein)
<span class="kw">library</span>(sf)</code></pre></div>
<pre><code>## Linking to GEOS 3.6.2, GDAL 2.2.3, PROJ 4.9.3</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(net)
net &lt;-<span class="st"> </span><span class="kw">st_transform</span>(<span class="kw">st_as_sf</span>(net), <span class="dv">31983</span>)
g &lt;-<span class="st"> </span><span class="kw">make_grid</span>(<span class="dt">spobj =</span> net, <span class="dt">width =</span> <span class="dv">500</span>)</code></pre></div>
<pre><code>## Number of lon points: 23
## Number of lat points: 21</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(g)</code></pre></div>
<pre><code>## [1] &quot;sf&quot;         &quot;data.frame&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(g<span class="op">$</span>geometry, <span class="dt">axes =</span> <span class="ot">TRUE</span>)
<span class="kw">plot</span>(net<span class="op">$</span>geometry, <span class="dt">add =</span> <span class="ot">TRUE</span>)</code></pre></div>
<div class="figure"><span id="fig:grid1"></span>
<img src="veinbook_files/figure-html/grid1-1.svg" alt="Grid with spacing of 500 mts" width="672" />
<p class="caption">
Figure 7.7: Grid with spacing of 500 mts
</p>
</div>
<p>The class of <code>net</code> is <code>SpatialLinesDataFrame</code>, which is converted to <code>sf</code>. Then, as the coordinate reference system of the net is WGS84 with epsg 4326, we are transforming to UTM to create a grid with a grid spacing of 500 m. The class of the grid object, <code>g</code> is “sf data.frame”.</p>
</div>
<div id="gridding-bottom-up-emissions-with-emis_grid" class="section level2">
<h2><span class="header-section-number">7.5</span> Gridding bottom-up emissions with <code>emis_grid</code></h2>
<p>The function<code>emis_grid</code> allocates emissions proportionally to each grid cell. The process is performed by the intersection between geometries and the grid. It means that requires “sr” according to with your location for the projection. It is assumed that spobj is a spatial*DataFrame or an “sf” with the pollutants in data. This function returns an object class “sf”.</p>
<p>Before <code>sf</code> era, i tried to use<code>raster::intersect</code> which imports <code>rgeos</code> and took <strong>ages</strong>. Then I started to use <span class="citation">QGIS Development Team (<a href="#ref-QGIS">2017</a>)</span> (<a href="https://www.qgis.org" class="uri">https://www.qgis.org</a>), and later the R package <span class="citation">Muenchow, Schratz, and Brenning (<a href="#ref-RQGIS">2018</a>)</span> which takes 10 minutes for allocating emissions of the mega-city of São Paulo and a grid spacing of 1 km. <em>10 min is not bad</em>. However, when <code>sf</code> appeared and also, included the Spatial Indexes (<a href="https://www.r-spatial.org/r/2017/06/22/spatial-index.html" class="uri">https://www.r-spatial.org/r/2017/06/22/spatial-index.html</a>), it changed the game. A new era started. It took <strong>5.5 seconds</strong>. I could not believe it. However, there also some I could accelerate this process importing some <code>data.table</code> Aggregation functions. Now <code>emis_grid</code> can aggregate large spatial extensions. I haven’t tried yet at continental scale. Let’s see the arguments:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">args</span>(vein<span class="op">::</span>emis_grid)</code></pre></div>
<pre><code>## function (spobj, g, sr, type = &quot;lines&quot;) 
## NULL</code></pre>
<p>Where,</p>
<ul>
<li><code>spobj</code> : A spatial dataframe of class “sp” or “sf”. When class is “sp” it is transformed to “sf”.</li>
<li><code>g</code>: A grid with class “SpatialPolygonsDataFrame” or “sf”.</li>
<li><code>sr</code>: Spatial reference, e.g., 31983. It is required if spobj and g are not projected. Please, see <a href="http://spatialreference.org/" class="uri">http://spatialreference.org/</a>.</li>
<li><code>type</code>: type of geometry: “lines” or “points”.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(net)
net<span class="op">@</span>data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">hdv =</span> net[[<span class="st">&quot;hdv&quot;</span>]])
g &lt;-<span class="st"> </span><span class="kw">make_grid</span>(<span class="dt">spobj =</span> net, <span class="dt">width =</span> <span class="dv">1</span><span class="op">/</span><span class="fl">102.47</span><span class="op">/</span><span class="dv">2</span>)</code></pre></div>
<pre><code>## Number of lon points: 23
## Number of lat points: 19</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">netg &lt;-<span class="st"> </span><span class="kw">emis_grid</span>(net, g)</code></pre></div>
<pre><code>## Sum of street emissions 148118</code></pre>
<pre><code>## although coordinates are longitude/latitude, st_intersection assumes that they are planar</code></pre>
<pre><code>## Sum of gridded emissions 148118</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(netg)</code></pre></div>
<pre><code>## Simple feature collection with 6 features and 2 fields
## geometry type:  POLYGON
## dimension:      XY
## bbox:           xmin: -46.8066 ymin: -23.62 xmax: -46.77732 ymax: -23.61512
## epsg (SRID):    4326
## proj4string:    +proj=longlat +datum=WGS84 +no_defs
##   id      hdv                       geometry
## 1  1 201.8275 POLYGON ((-46.8066 -23.62, ...
## 2  2 200.6097 POLYGON ((-46.80172 -23.62,...
## 3  3 205.6319 POLYGON ((-46.79684 -23.62,...
## 4  4 224.1988 POLYGON ((-46.79196 -23.62,...
## 5  5 770.9490 POLYGON ((-46.78708 -23.62,...
## 6  6   0.0000 POLYGON ((-46.7822 -23.62, ...</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(netg[<span class="st">&quot;hdv&quot;</span>], <span class="dt">axes =</span> <span class="ot">TRUE</span>)</code></pre></div>
<div class="figure"><span id="fig:netgldv"></span>
<img src="veinbook_files/figure-html/netgldv-1.svg" alt="Spatial grid of HDV traffic 500 mts" width="672" />
<p class="caption">
Figure 7.8: Spatial grid of HDV traffic 500 mts
</p>
</div>
<p>The example in this case, showed the allocation of traffic. The resulting object is a <code>sf</code> with the sum of the attributes inside each grid cell. This means that, when the input are street emissions at different hours, it will return gridded emissions at each hour:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">E_NOx_STREETS &lt;-<span class="st"> </span><span class="kw">emis_post</span>(E_NOx, <span class="dt">by =</span> <span class="st">&quot;streets_wide&quot;</span>, <span class="dt">net =</span> net)
NOxg &lt;-<span class="st"> </span><span class="kw">emis_grid</span>(E_NOx_STREETS, g)</code></pre></div>
<pre><code>## Sum of street emissions 34029872.64</code></pre>
<pre><code>## although coordinates are longitude/latitude, st_intersection assumes that they are planar</code></pre>
<pre><code>## Sum of gridded emissions 34029872.64</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(NOxg[<span class="st">&quot;V1&quot;</span>], <span class="dt">axes =</span> <span class="ot">TRUE</span>)</code></pre></div>
<div class="figure"><span id="fig:Noxg"></span>
<img src="veinbook_files/figure-html/Noxg-1.svg" alt="NOx emissions for 00:00 [g/h]" width="672" />
<p class="caption">
Figure 7.9: NOx emissions for 00:00 [g/h]
</p>
</div>
</div>
<div id="gridding-top-down-emissions-with-emis_dist" class="section level2">
<h2><span class="header-section-number">7.6</span> Gridding top-down emissions with <code>emis_dist</code></h2>
<p>When a top-down approach emissions inventory is made, the spatial distribution of emissions must be made considering some proxy. In the case of vehicular emissions, it can be done with data of Open Street Maps, distributing the emissions into the streets. This can be done with the function with the function <code>emis_dist</code>. In general, this function distributes the emissions into a spatial feature on any type, not only lines.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">args</span>(vein<span class="op">::</span>emis_dist)</code></pre></div>
<pre><code>## function (gy, spobj, pro, osm, verbose = TRUE) 
## NULL</code></pre>
<p>Where,</p>
<ul>
<li><code>gy</code>: Numeric; a unique total (top-down) emissions (grams)</li>
<li><code>spobj</code>: A spatial dataframe of class “sp” or “sf”. When class is “sp” it is transformed to “sf”.</li>
<li><code>pro</code>: Matrix or data-frame profiles, for instance, pc_profile.</li>
<li><code>osm</code>: Numeric; vector of length 5, for instance, c(5, 3, 2, 1, 1). The first element covers ‘motorway’ and ‘motorway_link. The second element covers ’trunk’ and ‘trunk_link’. The third element covers ‘primary’ and ‘primary_link’. The fourth element covers ‘secondary’ and ‘secondary_link’. The fifth element covers ‘tertiary’ and ‘tertiary_link’.</li>
<li><code>verbose</code>: Logical; to show more info.</li>
</ul>
<p>Let’s use the package <code>osmdata</code> to download OpenStreetMap data. The process presented in the following code consists of downloading the OpenStreetMap data delimited by the coordinates og the grid <code>g</code>. Then filter only the lines</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(osmdata)</code></pre></div>
<pre><code>## Data (c) OpenStreetMap contributors, ODbL 1.0. http://www.openstreetmap.org/copyright</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(sf, <span class="dt">quietly =</span> T)
osm &lt;-<span class="st"> </span><span class="kw">osmdata_sf</span>(
  <span class="kw">add_osm_feature</span>(
    <span class="kw">opq</span>(<span class="dt">bbox =</span> <span class="kw">st_bbox</span>(g)),                             
    <span class="dt">key =</span> <span class="st">&#39;highway&#39;</span>))<span class="op">$</span>osm_lines[, <span class="kw">c</span>(<span class="st">&quot;highway&quot;</span>)]
st &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;motorway&quot;</span>, <span class="st">&quot;motorway_link&quot;</span>, <span class="st">&quot;</span>
<span class="st">        trunk&quot;</span>, <span class="st">&quot;trunk_link&quot;</span>, 
        <span class="st">&quot;primary&quot;</span>, <span class="st">&quot;primary_link&quot;</span>, 
        <span class="st">&quot;secondary&quot;</span>, <span class="st">&quot;secondary_link&quot;</span>, 
        <span class="st">&quot;tertiary&quot;</span>, <span class="st">&quot;tertiary_link&quot;</span>)
osm &lt;-<span class="st"> </span>osm[osm<span class="op">$</span>highway <span class="op">%in%</span><span class="st"> </span>st, ]
<span class="kw">plot</span>(osm, <span class="dt">axes =</span> T)</code></pre></div>
<div class="figure"><span id="fig:osmsp"></span>
<img src="veinbook_files/figure-html/osmsp-1.svg" alt="Open street map lines" width="672" />
<p class="caption">
Figure 7.10: Open street map lines
</p>
</div>
<p>The we will distribute the total emissions of E_NOx 3.402987310^{7} into this new lines. There is the argument osm, which gives percentage weights to the type of streets in the following order: “motorway”, “trunk”, “primary”, “secondary” and “tertiary” . For instance <strong>osm = 5:1</strong> means 33% of emissions into “motorway” because it is 5 / (1 + 2 + 3 + 4 + 5).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">estreet &lt;-<span class="st"> </span><span class="kw">emis_dist</span>(<span class="dt">gy =</span> <span class="kw">sum</span>(E_NOx), <span class="dt">spobj =</span> osm)</code></pre></div>
<pre><code>## Columns: geometry emission</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">estreet<span class="op">$</span>emission_osm &lt;-<span class="st"> </span><span class="kw">emis_dist</span>(<span class="dt">gy =</span> <span class="kw">sum</span>(E_NOx), <span class="dt">spobj =</span> osm, 
                                   <span class="dt">osm =</span> <span class="dv">5</span><span class="op">:</span><span class="dv">1</span>)<span class="op">$</span>emission</code></pre></div>
<pre><code>## Selecting: motorway motorway_link trunk trunk_link primary primary_link secondary secondary_link tertiary tertiary_link 
## Columns: emission highway geometry</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(estreet[<span class="kw">c</span>(<span class="st">&quot;emission&quot;</span>)], 
     <span class="dt">main =</span> <span class="kw">paste0</span>(<span class="st">&quot;Emissions with Default distribution: &quot;</span>,
                   <span class="kw">round</span>(<span class="kw">sum</span>(estreet<span class="op">$</span>emission)), <span class="st">&quot; [g]&quot;</span>), 
     <span class="dt">axes =</span> T,<span class="dt">pal =</span> <span class="kw">cpt</span>(<span class="dt">colorRampPalette =</span> T))</code></pre></div>
<div class="figure"><span id="fig:osmemi"></span>
<img src="veinbook_files/figure-html/osmemi-1.svg" alt="Emissions distributed into OSM lines" width="672" />
<p class="caption">
Figure 7.11: Emissions distributed into OSM lines
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(estreet[<span class="kw">c</span>(<span class="st">&quot;emission_osm&quot;</span>)],
          <span class="dt">main =</span> <span class="kw">paste0</span>(<span class="st">&quot;Emission with OSM distribution: &quot;</span>,
                        <span class="kw">round</span>(<span class="kw">sum</span>(estreet<span class="op">$</span>emission_osm)), <span class="st">&quot; [g]&quot;</span>),  
     <span class="dt">axes =</span> T,<span class="dt">pal =</span> <span class="kw">cpt</span>(<span class="dt">colorRampPalette =</span> T))</code></pre></div>
<div class="figure"><span id="fig:osmemi"></span>
<img src="veinbook_files/figure-html/osmemi-2.svg" alt="Emissions distributed into OSM lines" width="672" />
<p class="caption">
Figure 7.11: Emissions distributed into OSM lines
</p>
</div>
</div>
<div id="gridding-top-down-emissions-with-grid_emis" class="section level2">
<h2><span class="header-section-number">7.7</span> Gridding top-down emissions with <code>grid_emis</code></h2>
<p>Another option to distribute top-down emissions consists in the use of the function <code>grid_emis</code>, which does a similar job than <code>emis_dist</code> but cell by cell. This means that the total emissions are distributed inside each grid cell and not one distribution for the whole domain. This function runs a lapply of <code>emis_dist</code>; hence it takes a little bit more time.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">args</span>(vein<span class="op">::</span>grid_emis)</code></pre></div>
<pre><code>## function (spobj, g, sr, pro, osm, verbose = TRUE) 
## NULL</code></pre>
<p>Where,</p>
<ul>
<li><code>spobj</code>: A spatial dataframe of class “sp” or “sf”. When class is “sp” it is transformed to “sf”.</li>
<li><code>g</code>: A grid with class “SpatialPolygonsDataFrame” or “sf”. This grid includes the total emissions with the column “emission”. If the profile is going to be used, the column ‘emission’ must include the sum of the emissions for each profile. For instance, if the profile covers the hourly emissions, the column ‘emission’ bust be the sum of the hourly emissions.</li>
<li><code>sr</code>: Spatial reference e.g., 31983. It is required if spobj and g are not projected. Please, see <a href="http://spatialreference.org/" class="uri">http://spatialreference.org/</a>.</li>
<li><code>pro</code>: Numeric, Matrix or data-frame profiles, for instance, pc_profile.</li>
<li><code>osm</code>: Numeric; vector of length 5, for instance, c(5, 3, 2, 1, 1). The first element covers ‘motorway’ and ‘motorway_link. The second element covers ’trunk’ and ‘trunk_link’. The third element covers ‘primary’ and ‘primary_link’. The fourth element covers ‘secondary’ and ‘secondary_link’. The fifth element covers ‘tertiary’ and ‘tertiary_link’.</li>
<li><code>verbose</code>: Logical; to show more info.</li>
</ul>
<p>It is required that the grid</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">NOxg &lt;-<span class="st"> </span>NOxg[, <span class="st">&quot;V1&quot;</span>]
<span class="kw">names</span>(NOxg)[<span class="dv">1</span>] &lt;-<span class="st"> &quot;emission&quot;</span>
xnet &lt;-<span class="st"> </span><span class="kw">grid_emis</span>(osm, NOxg)</code></pre></div>
<pre><code>## although coordinates are longitude/latitude, st_intersection assumes that they are planar</code></pre>
<pre><code>## Sum of gridded emissions 77253.6
## Sum of street emissions 77253.6
## Columns: emission geometry</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(xnet, <span class="dt">axes =</span> T,<span class="dt">pal =</span> <span class="kw">cpt</span>(<span class="dt">colorRampPalette =</span> T))</code></pre></div>
<div class="figure"><span id="fig:osmspgrid"></span>
<img src="veinbook_files/figure-html/osmspgrid-1.svg" alt="Use of grid_emis" width="672" />
<p class="caption">
Figure 7.12: Use of grid_emis
</p>
</div>

</div>
</div>
<h3>Appendix B</h3>
<div id="refs" class="references">
<div id="ref-QGIS">
<p>QGIS Development Team. 2017. <em>QGIS Geographic Information System</em>. Open Source Geospatial Foundation. <a href="http://qgis.osgeo.org" class="uri">http://qgis.osgeo.org</a>.</p>
</div>
<div id="ref-RQGIS">
<p>Muenchow, Jannes, Patrick Schratz, and Alexander Brenning. 2018. “RQGIS: Integrating R with Qgis for Statistical Geocomputing.” <em>R Journal</em>. <a href="https://rjournal.github.io/archive/2017/RJ-2017-067/RJ-2017-067.pdf" class="uri">https://rjournal.github.io/archive/2017/RJ-2017-067/RJ-2017-067.pdf</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="est.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="he.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/ibarraespinosa/VEINBOOK/edit/master/07-postemi.Rmd",
"text": "Edit"
},
"download": ["veinbook.pdf", "veinbook.epub", "veinbook.mobi"],
"toc": {
"collapse": "none"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
