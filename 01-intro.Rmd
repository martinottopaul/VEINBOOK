# Introduction {#intro}

## Definitions and sources of information

Developing emissions inventories is a complex task. Therefore, before entering into the details of the functions, it is good to provide some initial definitions.

A good starting point is a book _"The Art of Emissions Inventorying"_ [@pulles2010art]. This book provides a general description of what is an emissions inventory. One of the early sources of information about emissions inventories and emissions factors are the Environmental Protection Agency (U.S.EPA) and its compilation of emission factors AP42 (https://www.epa.gov/air-emissions-factors-and-quantification).
A third source of information is the European EMEP/EEA air pollutant emission inventory guidebook (https://www.eea.europa.eu/themes/air/emep-eea-air-pollutant-emission-inventory-guidebook/).

An emissions inventory is the compilation of all mass emitted into the atmosphere by activities in a defined area during a lapse of time. The Eq. (\@ref(eq:efGERAL) shows the
general form [@guia]:

\begin{equation}
Emission_{pollutant}=\sum_{activities} Activity \cdot Emission factor_{activity, pollutant}
(\#eq:efGERAL)
\end{equation}

There are two main kinds of inventories based on the application; one is for policy application and the other for scientific application [@pulles2010art]. 

- Inventories for policy application include the National Greenhouse Gas Inventory for the parties under the United Nations Framework on Climate Change [@unfccc].
- Emissions inventories with scientific applications include the Emission 
Database for Global Atmospheric Research EDGAR [@edgar].

Emissions inventories can also be multimedia inventories, such as the Pollutant Release
and Transfer Registers (PRTR) which include pollutants released to air, water, and soil and transferred off-site for treatment or disposal (http://www.oecd.org/chemicalsafety/pollutant-release-transfer-register/). However, the type of inventory covered in this book includes only the emissions released into the atmosphere.

### Approaches

It is necessary to show some definitions of vehicular emissions inventories approaches, which in this case comes from the European Emissions Guidelines [@NtziachristosSamaras2016]:

- **Top-down** uses input activity traffic data as fleet statistics,
fuel consumption, representative speeds, and country balances. The emissions factors are based on representative speeds. These inventories are also known as _static_.
- **Bottom-up** uses using input activity traffic data from traffic counts, traffic simulations, vehicle composition, speed recordings and length of roads. The emission factors are speed or/and acceleration functions. These inventories are also known as _dynamic_.
- **Reconciliation** Both approaches must be reconciled in urban emissions inventories with the comparison of total mileage, cold start mileage or emission factors to ensure that the comparison with the total fuel consumption in the study area is satisfactory.  Another point of calibration is that the estimation of fuel consumption must match the fuel sales in your study area.

## Installation

The VEIN R-package can be installed from Comprehensive R Archive Network 
[CRAN](https://cran.r-project.org/) directly:

```{r, eval=FALSE, echo = TRUE}
# CRAN
install.packages("vein")
```

VEIN can be also installed from github:

```{r, eval=FALSE}
library(devtools)
install_github("ibarraespinosa/vein")
```

The GitHub installation requires that the _devtools_ package [@devtools] must be installed, including dependencies.

## Required R packages and dependencies

VEIN imports functions from other R packages. Hence, these packages are necessary::

**sf** is a package that provides simple features access for R [@sf]. It depends on the libraries GEOS (http://trac.osgeo.org/geos), 'Geospatial' Data Abstraction Library ('GDAL')
(http://www.gdal.org/) also, PROJ (http://proj4.org/).
**data.table** is a package is an extension of data.frame class, providing high-speed operations [@datatable].
- **sp**. This is a package that provides classes and methods for spatial data [@sp] Considering points, lines, polygons, and grids. Few functions of 'sp' are imported, most of them come from sf.
**eixport** is a package [@eixport2] that creates inputs for atmospheric models [@eixport].
- **units**. It is a package for measurement units in R [@units]. This package depends on the library udunits2 (http://www.unidata.ucar.edu/software/udunits/). I


```{r, eval=FALSE}
install.packages(c("sf", "data.table", "sp", "eixport", "units"))
```

You have to install the package **sf**, including its
library dependencies into your operating system.

**Ubuntu**
```{bash eval=FALSE}
sudo add-apt-repository ppa:ubuntugis/ubuntugis-unstable
sudo apt-get update
sudo apt-get install libudunits2-dev libgdal-dev libgeos-dev libproj-dev 
```

**Fedora**
```{bash, eval=FALSE}
sudo dnf install gdal-devel proj-devel proj-epsg proj-nad 
geos-devel udunits2-devel
```

**Debian and other**

Dockerfiles from [rocker geospatial](https://github.com/rocker-org/geospatial).

**Windows**
Via [Rtools](https://cran.r-project.org/bin/windows/Rtools/).

**MAC OS**
```{bash, eval=FALSE}
brew unlink gdal
brew tap osgeo/osgeo4mac && brew tap --repair
brew install proj
brew install geos
brew install udunits
brew install gdal2 --with-armadillo --with-complete 
--with-libkml --with-unsupported
brew link --force gdal2
```

The R package eixport imports function from **ncdf4** [@ncdf4], therefore the library NetCDF
must be installed. For Ubuntu, do:
```{bash, eval = FALSE}
sudo apt install libnetcdf-dev  netcdf-bin 
```

<!-- The new version of VEIN will replace the spatial r-packages dependencies of  -->
<!-- raster, rgeos and rgdal by the new **sf** [@sf] package and the **units** [@units] package. -->

<!-- **sf** is a package that provides simple features access for R [@sf]. It can be installed -->
<!-- in this way: -->

<!-- ```{r, eval=FALSE} -->
<!-- install.packages("sf") -->
<!-- ``` -->

<!-- or via devtools -->

<!-- ```{r eval=FALSE} -->
<!-- library(devtools) -->
<!-- install_github("r-spatial/sf") -->
<!-- ``` -->


## Data inside the VEIN model

There are several datasets available inside the model:

### Emission factors from CETESB

- **fe2015**: Emission factors from the Environmental Agency of Sao Paulo (CETESB).
Pollutants included: "CH4", "CO", "CO2", "HC", "N2O", "NMHC", "NOx" and "PM". The
type of vehicles included is Passenger Cars (PC). Please note that I added a new function `ef_cetesb` in version 0.4.4 which covers all CETESB 
emission factors.

usage:
```{r}
library(vein, quietly = T)
data(fe2015)
```

```{r, echo=FALSE}
knitr::kable(
    head(fe2015[, c(1:3, 11, 12)], 6), 
  caption = 'Emission factors from CETESB in VEIN model',
  booktabs = TRUE
)
```


### Mileage functions of Brazilian Fleet

- **fkm**: A list of functions of mileage in km for the Brazilian fleet. It includes mileage
functions based on more than 2 million recordings of vehicles [@BruniBales2013]. It consists of a list of age functions. The type of cars are Passenger Cars (PC), Light 
Commercial Vehicles (LCV), Small Busses (SBUS), Trucks, Articulated Trucks (ATRUCKS),
Motorcycles (MOTO) and Light vehicles (LDV). The fuels are Gasoline using 25\% of
ethanol (E25), Ethanol 100\% (E100) and Diesel with 5\% of biodiesel (B5). There are
also vehicles with flex engines which can run either with E25, E100 or any mixture
in between [@2005-01-4130]. The Fig. (\@ref(fig:mil) shows the mileage of PC using fuel E25.


usage:
```{r mil, fig.cap='Mileage of PC using E25', out.width='80%', fig.asp=.75, fig.align='center'}
library(vein, quietly = T)
data(fkm)
names(fkm)
age <- 1:50
mileage <- fkm$KM_PC_E25(1:50) 
par(mar = c(4, 4, .1, .1))
plot(y = mileage, x = age, pch = 19, type = "b")
```


- **net**: Road network of the west part of Sao Paulo city. It consistes in a 
SpatialLinesDataFrame (class of sp) with the attributes ldv (light duty vehicles, 
$1 \cdot h^{-1}$), hdv (heavy duty vehicles, $1 \cdot h^{-1}$), ps (peak speed, 
$km \cdot h^{-1}$), ffs (free flow speed, $km \cdot h^{-1}$), tstreet (type of street), 
lanes (number of lanes), capacity (capacity fo vehicles at each link, 1/h) and tmin (time
for travelling each link, min). The Fig. (\@ref(traffic) shows more details.


### Temporal factors for Passenger Cars

Temporal factors (TF) are the matrix of hourly traffic data normalized for the hour of interest, usually the morning rush hour 08:00-09:00 in local time (LT) [@gmd-2017-193].
This dataset covers 168 hours of one week, from traffic counts of toll stations near the center of the city of SãoPaulo, Brazil. Fig.
(\@ref(fig:tf) shows the temporal factors for PC.

usage:
```{r tf, fig.cap='Temporal Factors for PC', out.width='80%', fig.asp=.75, fig.align='center'}
library(vein, quietly = T)
data(pc_profile)
tf <- unlist(pc_profile)
hours <- 1:168
par(mar = c(4, 4, .1, .1))
plot(y = tf, x = hours, pch = 16, type = "b")
```


### Profile for cold starts of Passenger Cars

I included a profile of hourly percentage of cold starts of Passenger Cars. This data covers 24 hours of a working day, and it is based cold start recordings during the implementation of the International Vehicle Emissions (IVE) model [@Davisetal2005] in São Paulo [@ivesp]. The Fig. (\@ref(fig:cold) shows the cold-start profile.

usage:
```{r cold, fig.cap='Cold-starts profile for PC', out.width='80%', fig.asp=.75, fig.align='center'}
library(vein, quietly = T)
data(pc_cold)
cold <- unlist(pc_cold)
hours <- 1:24
par(mar = c(4, 4, .1, .1))
plot(y = cold, x = hours, pch = 16, type = "b")
```

## Acknowledgements

Martin Ramacher, Ph.D. Student Chemistry Transport Modelling, Institute for Coastal Research, Helmholtz-Zentrum Geesthacht, Germany - Proofreading. Leila Droprinchinski Martins, Professor (Associate) Federal Technological University of Parana, Brazil - Comments.
