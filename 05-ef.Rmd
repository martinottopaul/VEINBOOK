# Emission Factors {#ef}

An emission factor is the amount of mass of pollutant generated by activities [@pulles2010art]. In the case of vehicles, the emission factors are generally known as the mass of pollutant per traveled distance $g \cdot km^{-1}$ in metric units. The distance unit could be different, like miles for instance.  The type of units depends on measurement used when developing the emission factors.

There are hot and cold exhaust emisions. _Hot_ exhaust emissions are produced by a vehicle when its engine and exhaust after-treatment system are at their normal operational temperatures and _Cold_ during the vehicle warm-up phase [@trlef].

The emission factors come from measurements of pollutants emitted by the sources. In the case of vehicles, the dynanometer measurements of the emission factors are the mass of pollutant collected during the distance traveled by a vehicle  following a specific driving cycle. The Federal Test Procedure (FTP) is a test to certify the vehicle emissions under the driving cycles such as FTP-75. This driving cycle has a duration of 1874 $s$ for a distance of 17783 $m$ and an average speed of 34.12 $km \cdot h^{-1}$ [@tim].

In the literature it is possible to find different type of emission factors. For instance, in Europe, during the development of the project Assesment of  Reliability of Transport Emission Models and Inventory Systems (ARTEMIS), the *traffic situation model* was developed. The model concept consists in the  combination of parameters that affects vehicle kinematics and engine operation: type of road, sinuosity and gradient, trafffic conditions or level of service (free-flow, heavy, saturated and stop and go) and average speed by speed limit of the road [@artemis]. Measurements of vehicular emissions under each traffic situation lead to emission factors by traffic situation, used in the Handbook of Emission Factors (HBEFA, www.hbefa.net).

There is another approach based on 1 Hz measurement of emissions. Here, the pollutants are measured on real live traffic driving. Emission factors can be derived here using mainly two approaches. One approach is applying the Vehicular Specific Power (VSP) [@jimenez1999vehicle]. This method is used in the Motor Vehicle Emission Simulator (MOVES) [@koupal2003design] and the International Vehicle Emissions model (IVE) [@Davisetal2005]. Another approach is to apply the Passenger car and Heavy-duty Emission Model (PHEM), which is based on instantaneous engine power demand and engine speed developed during the ARTEMIS 
project [@tim, @artemis].

Perhaps the most used approach to obtain emission factors are speed 
functions. As emissions tests on driving cycles are valid for only one
average speed, measuring emissions of different driving cycles at different average speeds, allows to obtain point clouds where a regression is applied, obtaining an emission factor as a speed function. The literature shows experiments in diffferent parts of the world, such as in Chile [@Corvalanetal2002] and Europe [@ntziachristos2000speed]. However, probably the most used source of emission factors as speed functions are the European emission guidelines developed by the European Monitoring and Evaluation Programme (EMEP, http://www.emep.int/) and published by the European
Environment Agency (EEA, https://www.eea.europa.eu/themes/air/emep-eea-air-pollutant-emission-inventory-guidebook/emep) [@NtziachristosSamaras2016]. These emission factors are included
in the VEIN model.

Another aspect important in vehicular emissions is the degradation of the
emissions of aged vehicles. Over the time, different part of the vehicles suffer deterioration, increasing the emissions. Therefore, approaches have been developed to account for this effect in inventories. One approach consists in determining functions that increment the emissions by accumulated mileage, such as studies of -@CorvalanVargas2003.

In Brazil, the emission factors are reported by the Environmental Protection Agency of SÃ£o Paulo -@CETESB2015, in their vehicular emissions inventory report. Light vehicles emission factors come from average measurements of the FTP75 driving cycle, motorcycle emission factors come from average measurements of World Motorcycle Test Cycle (WMTC) and HDV from the European Stationary Cycle (ETC).

As the VEIN model was developed in Brazil, but users of other parts of the world may be intereted in using the model, the approach in VEIN has to allow flexibility to the user. Therefore, the emission factors approach in VEIN consists in three options, as shown on Fig. (\@ref(fig:diaef)). The first approach consists in local emissions factors by age of use, such as the one from -@CETESB2015, denoted as local_ef in the green circle. The second approach consists in selecting speed functions from -@NtziachristosSamaras2016, availabe in VEIN and denoted as the grey box as speed_ef. The third approach conists in incorporating speed variation from the speed function into the local emission factors by age of use. In any case, VEIN uses a function to account for the degradation of emissions due to accumulated mileage (denoted in grey box as emis_det). These emissions are entered into the emission estimation function.

The following sections show how to do these calculation in VEIN, step by step.

```{r , include=FALSE, eval=FALSE,fig.cap='Structuring an emissions inventories with VEIN', out.width='50%', fig.asp=.75, fig.align='center', warning=FALSE}
library(DiagrammeR)
p1 <- grViz("digraph boxes_and_circles {
      graph [overlap = false,
            fontsize = 10,
            rankdir = LR,
            fontname = Helvetica]


      node [shape = box,
            style = filled,
            fillcolor = pink,
            fixedsize = false,
            color = black,
            fontcolor = black,
            fontize = 12]

      EmissionFactors;



      node [shape = circle,
            style = filled,
            fillcolor = SpringGreen,
            fixedsize = false,
            color = black,
            fontcolor = black,
            fontize = 12]

      local_ef;

      node [shape = box,
            style = filled,
            fixedsize = false,
            fillcolor = grey88,
            color = black,
            fontcolor = black,
            fontize = 12]

      speed_ef;

      edge [color = black,
            arrowhead = vee,
            penwidth = 1.5]

      emis_det->{local_ef speed_ef}
      local_ef->{scaled_ef EmissionFactors}
      speed_ef-> {scaled_ef  EmissionFactors}
      scaled_ef -> EmissionFactors
      EmissionFactors -> emis
      }
      ")
```


```{r diaef, echo = FALSE, fig.cap='Structuring an emissions inventories with VEIN', out.width='100%', fig.asp=.75, fig.align='center', warning=FALSE}
knitr::include_graphics("figuras/dia5.png")
```

## Speed functions `ef_ldv_speed` and `ef_hdv_speed` {#speedef} 

The estimation of emissions in VEIn is shown the equation \@ref(eq:emi):

\begin{equation}
EH_{i,j,k,l,m} =F_{i,j,k,l} \cdot L_i \cdot EF(V_{i,l})_{j,k,m} \cdot DF_{j,k}
(\#eq:emi)
\end{equation}

where
$EH_{i,j,k,l,m}$ is the emission for each street link $i$, vehicle category
from composition $k$, hour $l$ and pollutant $m$,  $F_{i,j,k,l}$ is the vehicular flow calculated in Eq. 1.  $L_i$ is the length of the street link $i$. $EF(V_{i,l})_{j,k,m}$ is the emission factor of each pollutant $m$. 
$DF_{j,k}$ is the deterioration factor for vehicle of type $j$ and age of use $k$, explained in detail in section \@ref(det).


These functions return speed functions as $f(V)$. The functions come from the EMEP/EEA emissions guidelines [@NtziachristosSamaras2016] and are available in PDF reports. The equations and their parameters were translated to spreedsheets and loaded internally in VEIN. Therefore, the user only must enter the required parameters obtaining the desired function. The functions respect the assumptions and speed limits.

### Emission factors of LDV depending on  speed with the function `ef_ldv_speed`

The arguments for `ef_ldv_speed` are:

- `v`: Category of vehicle: "PC", "LCV", "Motorcycle" or "Moped".
- `t`: Sub-category of vehicle: PC: "ECE_1501", "ECE_1502", "ECE_1503", 
"ECE_1504" , "IMPROVED_CONVENTIONAL", "OPEN_LOOP", "ALL", "2S" or "4S". LCV: "4S",  Motorcycle: "2S" or "4S". Moped: "2S" or "4S".
- `cc`: Size of engine in cc: PC: "<=1400", ">1400", "1400_2000", ">2000", "<=800", "<=2000". Motorcycle: ">=50" (for "2S"), "<=250", "250_750", ">=750". Moped: "<=50". LCV : "<3.5" for gross weight.
- `f`: Type of fuel: "G", "D", "LPG" or "FH" (Full Hybrid: starts by electric 
motor).
- `eu`: Euro standard: "PRE", "I", "II", "III", "III+DPF", "IV", "V", "VI" or 
"VIc".
- `p`: Pollutants:  **Criteria**: "CO", "NOx", "HC", "PM", "CH4", "NMHC", "CO2", "SO2",
"Pb", "FC" (Fuel Consumption).
- **PAH and POP**: "indeno(1,2,3-cd)pyrene", "benzo(k)fluoranthene", "benzo(b)fluoranthene", "benzo(ghi)perylene", "fluoranthene", "benzo(a)pyrene", "pyrene", "perylene",  "anthanthrene", "benzo(b)fluorene", "benzo(e)pyrene", "triphenylene", "benzo(j)fluoranthene", "dibenzo(a,j)anthacene", "dibenzo(a,l)pyrene", "3,6-dimethyl-phenanthrene", "benzo(a)anthracene", "acenaphthylene", "acenapthene", "fluorene",
"chrysene", "phenanthrene", "napthalene",  "anthracene", "coronene",
"dibenzo(ah)anthracene" **Dioxins and Furans**: "PCDD", "PCDF", "PCB".
- **Metals**: "As", "Cd", "Cr", "Cu", "Hg", "Ni", "Pb", "Se", "Zn".
- **NMHC**:
-  _ALKANES_: "ethane", "propane", "butane", "isobutane", "pentane",
"isopentane", "hexane", "heptane", "octane", "TWO_methylhexane", "nonane", "TWO_methylheptane", "THREE_methylhexane", "decane", "THREE_methylheptane", "alcanes_C10_C12", "alkanes_C13".
- _CYCLOALKANES_: "cycloalcanes".
- _ALKENES_: "ethylene", "propylene", "propadiene", "ONE_butene",
"isobutene", "TWO_butene", "ONE_3_butadiene", "ONE_pentene", "TWO_pentene", "ONE_hexene", "dimethylhexene".
- _ALKYNES_:"ONE_butine", "propine", "acetylene".
- _ALDEHYDES_: "formaldehyde", "acetaldehyde", "acrolein", "benzaldehyde", "crotonaldehyde", "methacrolein", "butyraldehyde", "isobutanaldehyde", "propionaldehyde", "hexanal", "i_valeraldehyde", "valeraldehyde", "o_tolualdehyde", "m_tolualdehyde", "p_tolualdehyde".
- KETONES: "acetone", "methylethlketone".
- _AROMATICS_: "toluene", "ethylbenzene", "m_p_xylene", "o_xylene",
"ONE_2_3_trimethylbenzene", "ONE_2_4_trimethylbenzene",
"ONE_3_5_trimethylbenzene", "styrene", "benzene", "C9", "C10", "C13".
- `k`: Multiplication factor.
- `show.equation`: Option to see (or not) the equation parameters.

It is very important that the user enters the right values into the arguments because the final category must match. If the user enters values that do not match, the resulting speed function will be wrong. There are 146 matchs. The probably most used combinations are:

```{r, echo=FALSE}
df <- read.csv("figuras/matchs.csv")
df <- df[df$v %in% c("PC", "LCV", "Motorcycle") &
           df$t == "4S", ]
df <- data.frame(
  Argument  = c("v", "t", "cc", "f", "eu", "p"),
  Value = c("PC LCV Motorcycles",
            "4S",
            "<=1400 1400_2000 >2000",
            "G D",
            "PRE I II III IV V VI",
            "CO NOx HC FC PM"))
knitr::kable(df,
             caption = 'Most used combinations for emission factors for LDV',
             booktabs = TRUE
)
```

The returning speed function represents how a type of vehicle emits pollutants on average. Fig. (\@ref(fig:figef)) shows the emissions of CO by Passenger Cars with with technologies Pre Euro and Euro I from -@NtziachristosSamaras2016. Higher emissions occure at low average speeds and older vehicles with technologies pre Euro emit more than vehicles with Euro I. Even more, the average emissions of Pre Euro are 29.31 $g \cdot km^{-1}$ and Euro I 2.61 $g \cdot km^{-1}$, meaning that, on average, a vehicle Pre euro is 14 times higher than a vehicle with euro I. 

The Fig. (\@ref(fig:figef)) shows the plot using the package ggplot2 [@ggplot2]. This package requires that the data must be in long format. 

```{r figef, fig.cap='Emission factor as a speed function', out.width='80%', fig.asp=.75, fig.align='center'}
library(vein)
library(ggplot2)
ef1 <- ef_ldv_speed(v = "PC", cc = "<=1400", f = "G",
                    eu = "PRE", p = "CO", show.equation = F)
ef2 <- ef_ldv_speed(v = "PC", cc = "<=1400", f = "G",
                    eu = "I", p = "CO", show.equation = F)
V <- 0:110
df <- data.frame(EF = c(ef1(V), ef2(V)))
df$V = V
df$Euro <- factor(c(rep("PRE", 111), rep("I", 111)),
                  levels = c("PRE", "I"))
ggplot(df, aes(V, EF, colour = Euro)) + geom_point(size = 3) +
  geom_line() + theme_bw()+
  labs(y = "CO[g/km]", x = "[km/h]")
```

### Emission factors of HDV depending on  speed with the function `ef_hdv_speed`

The arguments for `ef_hdv_speed` are:

```{r}
args(ef_hdv_speed)
```

- `v`    Category of vehicle: "Coach", "Trucks" or "Ubus"
- `t`    Sub-category of vehicle: "3Axes", "Artic", "Midi", "RT, "Std" and "TT"
- `g`    Gross weight of each category: "<=18", ">18", "<=15", ">15 & <=18", "<=7.5", - ">7.5 & <=12", ">12 & <=14", ">14 & <=20", ">20 & <=26", ">26 & <=28", ">28 & <=32", ">32", ">20 & <=28", ">28 & <=34", ">34 & <=40", ">40 & <=50" or ">50 & <=60"
- `eu    Euro emission standard: "PRE", "I", "II", "III", "IV" and "V"
- `gr    Gradient or slope of road: -0.06, -0.04, -0.02, 0.00, 0.02. 0.04 or 0.06
- `l`    Load of the vehicle: 0.0, 0.5 or 1.0
- `p`    Pollutant:  **Criteria**: "CO", "NOx", "HC", "PM", "CH4", "NMHC", "CO2", "SO2", "Pb", "FC" (Fuel Consumption).
- **PAH and POP**: "indeno(1,2,3-cd)pyrene", "benzo(k)fluoranthene",
"benzo(b)fluoranthene", "benzo(ghi)perylene", "fluoranthene",
"benzo(a)pyrene", "pyrene", "perylene",  "anthanthrene", "benzo(b)fluorene", "benzo(e)pyrene", "triphenylene", "benzo(j)fluoranthene", "dibenzo(a,j)anthacene", "dibenzo(a,l)pyrene", "3,6-dimethyl-phenanthrene", "benzo(a)anthracene", "acenaphthylene", "acenapthene", "fluorene", "chrysene", "phenanthrene", "napthalene",  "anthracene", "coronene", "dibenzo(ah)anthracene" 
- **Dioxins and Furans**: "PCDD", "PCDF", "PCB".
- **Metals**: "As", "Cd", "Cr", "Cu", "Hg", "Ni", "Pb", "Se", "Zn".
- **NMHC**: 
- _ALKANES_: "ethane", "propane", "butane", "isobutane", "pentane",
"isopentane", "hexane", "heptane", "octane", "TWO_methylhexane", "nonane", "TWO_methylheptane", "THREE_methylhexane", "decane", "THREE_methylheptane", "alcanes_C10_C12", "alkanes_C13".
- _CYCLOALKANES_: "cycloalcanes".
- _ALKENES_: "ethylene", "propylene", "propadiene", "ONE_butene",
"isobutene", "TWO_butene", "ONE_3_butadiene", "ONE_pentene", "TWO_pentene", "ONE_hexene", "dimethylhexene".
- _ALKYNES_:"ONE_butine", "propine", "acetylene".
- _ALDEHYDES_: "formaldehyde", "acetaldehyde", "acrolein", "benzaldehyde", "crotonaldehyde", "methacrolein", "butyraldehyde", "isobutanaldehyde", "propionaldehyde", "hexanal", "i_valeraldehyde", "valeraldehyde", "o_tolualdehyde", "m_tolualdehyde", "p_tolualdehyde".
- KETONES: "acetone", "methylethlketone".
- _AROMATICS_: "toluene", "ethylbenzene", "m_p_xylene", "o_xylene",
"ONE_2_3_trimethylbenzene", "ONE_2_4_trimethylbenzene",
"ONE_3_5_trimethylbenzene", "styrene", "benzene", "C9", "C10", "C13".
- `k`: Multiplication factor.
- `k`    Multiplication factor
- `show.equation`    Option to see or not the equation parameters

```{r}
V <- 0:130
ef1 <- ef_hdv_speed(v = "Trucks",t = "RT", g = "<=7.5",
                    e = "II", gr = 0,
l = 0.5, p = "HC", show.equation = FALSE)
ef2 <- ef_hdv_speed(v = "Trucks",t = "RT", g = "<=7.5",
                    e = "II", gr = 0.06,
l = 0.5, p = "HC", show.equation = FALSE)
plot(1:130, ef1(1:130), pch = 16, type = "b",
     ylab = "HC [g/km]", xlab = "Speed [km/h]")
lines(1:130, ef2(1:130), pch = 16, type = "b", col = "blue")

```

## Local emission factors by age of use. The functions `EmissionFactors` and `EmissionFactorsList` {#localef}

The functions `EmissionFactors` and `EmissionFactorsList` create the classes with same names. The class `EmissionFactors` is also a data-frame with numeric columns with units of $g \cdot km^{-1}$. This class is not used in  critical steps of VEIN, and it has a purpose of creating a data-frame with numeric columns and units. The function is applied to a numeric vector and it just converts it to `units` adding units to it.

In the case of `EmissionFactorsList`, this class is a list of functions $f(V)$.
This is usefull because the `emis` function, seen in detail on chapter
\@ref(est), requires that the emission factors are functions of velocity $f(V)$, regardless $f(V)$ if it is constant or not. When this function is applied to a data-frame or to a matrix, it returns a list and each column of the data-frame  or matrix is another list. Also, each row of the original data-frame is converted to a $f(V)$. 

The arguments or `EmissionFactorsList` and `EmissionFactors` are:

-`x`: Object with class "data.frame", "matrix" or "numeric"

The following lines of code show examples using `EmissionFactors`. Firstly, it is loaded the dataset of emission factors _fe2015_ for CO and the vehicles PC using gasoline PC_G and Light Trucks LT. The class of fe2015 is data-frame. The subset of the data is named DF_CO. The first 6 elemens of the data-frame are numbers without units.

```{r}
library(vein)
data(fe2015) #CETESB Emission factors
DF_CO <- fe2015[fe2015$Pollutant=="CO", c("PC_G", "LT")]
head(DF_CO)
```

The object EF_CO is of class `EmissionFactors` and "data-frame" and each observation has the units $g \cdot km^{-1}$.

```{r}
EF_CO <- EmissionFactors(DF_CO)
head(EF_CO)
class(EF_CO)
```

The plot of an object of class `EmissionFactors` shows maximum 9 emission factors. Fig. (\@ref(fig:efco)) shows the emission factors of both categories, where newer vehicles emit less and older vehicles emit more.

```{r efco, fig.cap='Emission factor of PC and LT by age of use', out.width='80%', fig.asp=.75, fig.align='center'}
plot(EF_CO, xlab = "Age of use")
```

Regarding the class `EmissionFactorsList`, the `print` and `summary` methods are very simple, only showing a description of the object. The example of the following lines of code also uses the same set of Emission Factors from -@CETESB2015. The resulting object, EF_COL, is of class `EmissionFactorsList` and `list`. The print of the object shows only a description of the first and last member of the list object.


```{r}
EFL_CO <- EmissionFactorsList(DF_CO)
class(EFL_CO)
EFL_CO
```

Indeed, if we want to see the content of the `EmissionFactorsList` we have to extract the elements of the list. EFL_CO has two lists; one for PC and one for LT. Then, each list has 36 functions, the command `class(EFL_CO[[1]][[1]])` shows the object is a function $f(V)$.

```{r}
EFL_CO[[1]][[1]]
```

Also, as the speed functions are constant, there is no need to add values of V. 

```{r}
EFL_CO[[1]][[1]](100) # constant speed function
EFL_CO[[1]][[1]](0)   # constant speed function
```

Finally, after extracting the value, Fig.
(\@ref(fig:efco2)) shows the same figure as Fig. (\@ref(fig:efco))

```{r efco2, fig.cap='Emission factor of PC and LT', out.width='80%', fig.asp=.75, fig.align='center'}
efco1 <- sapply(1:36, function(i) EFL_CO[[1]][[i]]())
efco2 <- sapply(1:36, function(i) EFL_CO[[2]][[i]]())
df <- EmissionFactors(cbind(efco1, efco2))
plot(df, xlab = "Age of use")

```

## Incorporating speed variation with the functions `ef_ldv_scaled` and `ef_hdv_scaled`  {#scale}

The functions in section \@ref(speedef) and \@ref(localef) showed the speed and local emission factors respectively. However, the user might have local and constant emission factors depending only on the age of use, but also, outputs from a traffic demand model which includes speed. Under those circumstances, it would be interesting to investigate the effects of the average speed of traffic flow. VEIN includes functions to transform a constant emission factor by age of use into a speed dependent function.

These functions are called `ef_ldv_scaled` and `ef_hdv_scaled`. The concept is explained in detail in my Ph.D thesis [@ibarrathesis]. The idea comes from  revisiting the nature of the local emission factors. The Brazilian emission factors consist of average measurements for emissions certification tests which use the  driving cycles Federal Test Procedure FTP-75 for LDV, World Motorcycle Test Cycle (WMTC) for motorcycles, and also the European Stationary Cycle (ESC) for HDV [@CETESB2015]. The average speed of FTP-75 and WMTC are known, being 34.2 $km \cdot h^{-1}$ and 54.7 $km \cdot h^{-1}$ based on the reference report on driving cycles from the Transport and Research Laboratory (TRL) [@tim]. In the case of ESC, the user might search on literature a way to relate this cycle with an average speed.

Coming back to the -@CETESB2015 emission factors, these are annual average values of emissions for the different technologies to accomplish Brazilian emission  standards, which are valid only for a specific average speed.If two vehicles have similar technology but different emission factors, one constant and other speed function, it would be possble to relate them. These functions use the speed to  relate both emission factors. The condition to transform a contant emission factor into a speed dependent function is that, the new speed dependent function must be of the same value at the speed which is representative for the local factor,
and the values at other speeds are the incorporation of the speed variation. The equation \@ref(eq:efscaled) shows the procedure:

\begin{equation}
EF_{scaled}(V_{i,l})_{j,k,m}=EF(V_{i,l})_{j,k,m} \cdot \frac{EFlocal_{j,k,m}}{{EF(Vdc_{i,l})_{j,k,m}}}
(\#eq:efscaled)
\end{equation}

Where 
$EF_{scaled}(V_{i,l})_{j,k,m}$ is the scaled emission factor and $EF(V_{i,l})_{j,k,m}$ is the Copert emission factor for each street link $i$,
vehicle from composition $k$, hour $l$ and pollutant $m$.  $EFlocal_{j,k,m}$ represents the constant emission factor (not as speed functions).  $EF(Vdc_{i,l})_{j,k,m}$ are Copert emission factors with average speed value of the respective driving cycle for the vehicular category $j$. 

The functions `ef_ldv_scaled` and `ef_hdv_scaled` return scaled emissions factors automatically. The arguments are:

```{r}
args(ef_ldv_scaled)
```

- `df`: Data-frame with emission factors (Deprecated in 0.3.10).
- `dfcol`: Numeric vector with the emission factors constant by age of use. These emission factors are the target to incorporate speed variation.
- `SDC`: A number with the speed of the driving cycle of the emission factors from the argument `dfcol`. The resulting speed functions will return the same values of dfcol at the speed `SDC`. The default is 34.12 "km/h".
- `v`. Category of vehicle: "PC", "LCV", "Motorcycle" or "Moped". 
- `t`. Character; sub-category of vehicle: PC: "ECE_1501", "ECE_1502",
"ECE_1503", "ECE_1504" , "IMPROVED_CONVENTIONAL", "OPEN_LOOP", "ALL", "2S" or "4S". LCV: "4S", Motorcycle: "2S" or "4S". Moped: "2S" or "4S". The default is `4S`.
- `cc`. Character; size of engine in cc: PC: "<=1400", ">1400", "1400_2000", 
">2000", "<=800", "<=2000". Motorcycle: ">=50" (for "2S"), "<=250", "250_750", 
">=750". Moped: "<=50". LCV : "<3.5" for gross weight.
- `f`: Character; type of fuel: "G", "D", "LPG" or "FH" (Full Hybrid: starts by 
electric motor).
- `eu`: Character; euro standard: "PRE", "I", "II", "III", "III+DPF", "IV", "V", "VI" or "VIc".
- `p`: Character; pollutant: "CO", "FC", "NOx", "HC" or "PM".

And the argument of `ef_hdv_scaled` are:

```{r}
args(ef_hdv_scaled)
```

- `df`: Data-frame with emission factors (Deprecated in 0.3.10).
- `dfcol`: Numeric vector with the emission factors constant by age of use. - `SDC` Speed of the driving cycle.
- `v`: Category vehicle: "Coach", "Trucks" or "Ubus"
- `t`: Sub-category of of vehicle: "3Axes", "Artic", "Midi", "RT, "Std" and "TT"
- `g`: Gross weight of each category: "<=18", ">18", "<=15", ">15 & <=18", "<=7.5", ">7.5 & <=12", ">12 & <=14", ">14 & <=20", ">20 & <=26", ">26 & <=28", ">28 & <=32", ">32", ">20 & <=28", ">28 & <=34", ">34 & <=40", ">40 & <=50" or ">50 & <=60"
- `eu`: Euro emission standard: "PRE", "I", "II", "III", "IV" and "V"
- `gr`: Gradient or slope of road: -0.06, -0.04, -0.02, 0.00, 0.02. 0.04 or 0.06
- `l`: Load of the vehicle: 0.0, 0.5 or 1.0
- `p`: Pollutant: "CO", "FC", "NOx" or "HC"

## Cold Starts

Cold start emissions are produced during engine startup, when the engine and/or catalytic converter system has not reached its normal operational temperature. Several studies have shown the significant impact for these types of emissions  [@chenetal2011, @Weilenmannetal2009]. Under this condition emissions will be 
higher, and if the atmospheric temperature decreases, cold start emissions will  increase regardless of whether the catalyst has reached its optimum temperature for functioning [@artemis]. VEIN also considers cold start emissions using the approach outlined in Copert [@NtziachristosSamaras2016], as shown in equation  \@ref(eq:cold).

\begin{equation}
EC_{i,j,k,l,m} =\beta_{j} \cdot F_{i,j,k,l} \cdot L_i \cdot EF(V_{i,l})_{j,k,m} \cdot DF_{j.k} \cdot \left(EF_{\mbox{cold}}(ta_n,V_{i,l})_{j,k,m}-1\right)
(\#eq:cold)
\end{equation}

This approach adds two terms to Eq. \ref{eq:emi}. The first term
$EF_{cold}(ta_n,V_{i,l})_{j,k,m}-1$ is the emission factors for cold start 
conditions at each street link $i$, vehicle category from composition $k$, hour $l$ and pollutant $m$ and monthly average temperature $n$.
[@NtziachristosSamaras2016] suggest using monthly average temperature. This is an  important aspect that will be reviewed in future versions of VEIN.

The second term $\beta_j$ is defined as the fraction of mileage driven with a cold engine/catalyst [@NtziachristosSamaras2016]. The VEIN model incorporates a dataset  of cold starts recorded during the implementation of the International Vehicle Emissions (IVE) model [@Davisetal2005] in SÃ£o Paulo [@ivesp], which provides the hourly mileage driven with cold start conditions.

The function for cold start emission factors is `ef_ldv_cold` and its arguments are:

```{r}
args(ef_ldv_cold)
```

where:

- `v`: Category of vehicle: "LDV".
- `ta`: Ambient temperature. Monthly mean can be used.
- `cc`: Size of engine in cc: "<=1400", "1400_2000" or ">2000".
- `f`: Type of fuel: "G", "D" or "LPG".
- `eu`: Euro standard: "PRE", "I", "II", "III", "IV", "V", "VI" or "VIc".
- `p`: Pollutant: "CO", "FC", "NOx", "HC" or "PM".
- `k`: Multiplication factor.
- `show.equation`: Option to see or not the equation parameters.


```{r}
ef1 <- ef_ldv_cold(ta = -5, cc = "<=1400", f ="G", eu = "I", p = "CO")
ef2 <- ef_ldv_cold(ta = 0, cc = "<=1400", f ="G", eu = "I", p = "CO")
ef3 <- ef_ldv_cold(ta = 5, cc = "<=1400", f ="G", eu = "I", p = "CO")
ef4 <- ef_ldv_cold(ta = 10, cc = "<=1400", f ="G", eu = "I", p = "CO")
```

```{r efcold, fig.cap='Cold Emission factor of PC CO (g/km)', out.width='80%', fig.asp=.75, fig.align='center', echo = FALSE}
library(ggplot2)
V <- 0:100
df <- data.frame(EF = c(ef1(V), ef2(V), ef3(V), ef4(V) ))
df$Speed <- V
df$Temperature <- factor(c(rep("-5", length(V)),
                    rep( "0", length(V)),
                    rep("5", length(V)),
                    rep("10", length(V))),
                    levels = c("10", "5", "0", "-5"))
ggplot(df, aes(x = Speed, y = EF, colour = Temperature)) +
  geom_point(size = 2) + geom_line() +
  theme_bw() +
  labs(x = "Speed [g/km]", y = "CO [g/km]")
```

There is another function called `ef_ldv_cold_list` which will be deprecated soon.

## Deterioration {#det}

By default, VEIN includes deterioration factors from Copert 
[@NtziachristosSamaras2016]. However, it is possible to include other sources, such as from [@CorvalanVargas2003] or include deteriorated local emission factors. This aspesct is faced in VEIN with the function `emis_det`. This function returns deteriorated factors, as numeric vectors, which must be multiplied with the emission factors of vehicles with 0 mileage.

The arguments of this functions are:

```{r}
args(emis_det)
```

where:

- `p`: Pollutant.
- `cc`: Size of engine in cc.
- `eu`: Euro standard: "PRE", "I", "II", "III", "III", "IV", "V", "VI".
- `km`: mileage in km. VEIN includes a dataset of mileage function named "fkm".

```{r efDET, fig.cap='Deteriorated (red) and not-deteriorated (blue) EF CO', out.width='80%', fig.asp=.75, fig.align='center'}

data(fe2015)
data(fkm)
pckma <- cumsum(fkm$KM_PC_E25(1:24)) #only vehicles with catalizer
x1 <- fe2015[fe2015$Pollutant == "CO", ]
x1E3 <- subset(x1, x1$Euro_LDV %in% c("III", "IV", "V"))$PC_G
x1E1 <- subset(x1, x1$Euro_LDV %in% c("I", "II"))$PC_G
det_E3 <- emis_det(po = "CO", cc = 1000, eu = "III",
                   km = pckma[1:length(x1E3)])
det_E1 <- emis_det(po = "CO", cc = 1000, eu = "III",
                   km = pckma[(length(x1E3) + 1):23 ])
original_EF <- x1$PC
deteriorated_EF <- x1$PC * c(det_E3, det_E1, rep(1, 13))
plot(x = 1:36, y = original_EF, type = "b", pch = 15, col = "blue",
     ylab = "CO[g/km]", xlab = "Age of use")
#     main = "Deteriorated (red) and not-deteriorated (blue) EF CO")
lines(x = 1:36, y = deteriorated_EF,  type = "b", pch = 16, col = "red")

```

## Evaporative emissions `ef_evap`

Evaporative emissions are important sources of hydrocarbons and these emissions are produced by vaporization of fuel due to variations in ambient temperatures [@MelliosNtziachristos2016, @Andradeetal2017]. There are three types of emissions:  **diurnal emissions**, due to increases in atmospheric temperature, which lead to thermal expansion of vapor fuel inside the tank;  **running losses**, when the fuel evaporates inside the tank due to normal operation of the vehicle; and 
**hot soak** emissions, which occur when the hot engine is turned off. 
These methods implemented in VEIN were sourced from the evaporative emissions methods of Copert Tier 2  [@MelliosNtziachristos2016]. In VEIN it is also possible to use local emission factors. Here I'm showing both approaches:

a) Tier 2 copert approach

\begin{equation}
EV_{j,k} =\sum_{s}D_{s} \cdot \sum_{j}F_{j} \cdot (HS_{j,k}+de_{j,k}+RL_{j,k}) 
(\#eq:ev1)
\end{equation}

where 
$EV_{j}$ are the volatile organic compounds (VOC) evaporative emissions due  to each type of vehicle $j$.  $D_s$ is the "seasonal days" or number of days when the mean monthly  temperature is within a determined range:  [-5$^{\circ}$,10$^{\circ}$C],  [0$^{\circ}$,  15$^{\circ}$C], [10$^{\circ}$,  25$^{\circ}$C] and [20$^{\circ}$, 35$^{\circ}$C]. $F_{j,k}$ is the number of vehicles according to the same type $j$ and age  of use $k$.  $HS_{j,k}$, $de_{j,k}$ and $RL_{j,k}$ are average hot/warm soak, diurnal and  running losses evaporative emissions ($\mathrm{g \cdot day^{-1}}$), respectively, according to the vehicle type $j$ and age of use $k$.  $HS_{j,k}$ and $RL_{j,k}$ are obtained using equations also sourced from [@MelliosNtziachristos2016]:

\begin{equation}
HS_{j,k} = x_{j,k} \cdot (c \cdot (p \cdot e_{shc}+(1-p) \cdot e_{swc})+(1-c) \cdot e_{shfi} )
(\#eq:ev2)
\end{equation}

where: 
$x$ is the number of trips per day for the vehicular type $j$ and age of use $k$. $c$ is the fraction of vehicles with fuel return systems.  $p$ is the fraction of trips finished with hot engine, for example, an engine that 
has reached its normal operating temperature and the catalyst has reached its  light-off temperature [@NtziachristosSamaras2016]. The light-off temperature is  the temperature at the point when catalytic reactions occur inside a catalytic  converter. $e_{shc}$ and $e_{swc}$ are average hot-soak and warm-soak emission factors for gasoline  vehicles with carburettor or fuel return systems ($\mathrm{g \cdot parking^{-1}}$).
$e_{shfi}$  is the average hot-soak emission factors for gasoline vehicles equipped with fuel injection and non-return fuel systems ($\mathrm{g \cdot parking^{-1}}$).

The Eq. \@ref(eq:ev3) shows the procedure.

\begin{equation}
RL_{j,k} = x_{j,k} \cdot (c \cdot (p \cdot e_{rhc}+(1-p) \cdot e_{rwc})+(1-c) \cdot e_{rhfi} )
(\#eq:ev3)
\end{equation}

where:
$x$ and $p$ have the same meanings of Eq. \@ref(eq:ev2). $e_{rhc}$ and  $e_{rwc}$ are average hot and warm running losses emission factors  for gasoline vehicles with carburettor or fuel return systems ($\mathrm{g \cdot trip^{-1}}$)  $e_{rhfi}$ are average hot running losses emission factors for gasoline vehicles  equipped withfuel injection and non-return fuel systems ($\mathrm{g \cdot trip^{-1}}$).

It is recommended to estimate the number of trips per day [@MelliosNtziachristos2016], $x$, as the division between the mileage and 365 times the length of trip: $x = \frac{mileage_j}{(365 \cdot ltrip)}$. 

However, the mileage of a vehicle is not constant throughout the years. Therefore, VEIN incorporates a dataset of equations to estimate mileage of different types of vehicles by age of use [@BruniBales2013].

The function for evaporative emission factors is `ef_evap` and it arguments are :

```{r}
args(ef_evap)
```

where:
- `ef`:    Name of evaporative emission factor as *eshotc* ($g \cdot proced^-1$): mean hot-soak with carburator, *eswarmc* ($g \cdot proced^-1$): mean cold and warm-soak with carburator, *eshotfi*: mean hot-soak with fuel injection, *erhotc*  ($g \cdot trip^-1$): mean hot running losses with  carburator, *erwarmc*  ($g \cdot trip^-1$) mean cold and warm running losses, *erhotfi*  ($g \cdot trip^-1$) mean hot running 
losses with fuel injection.
- `v`: Type of vehicles, "PC", "Motorcycles", "Motorcycles_2S" and "Moped"
- `cc`: Size of engine in cc. PC "<=1400", "1400_2000" and "2000" Motorcycles_2S: "<=50". Motorcyces: ">50", "<250", "250_750" and ">750"
- `dt`: Average daily temperature variation: "-5_10", "0_15", "10_25" and "20_35"
- `ca`: Size of canister: "no" meaning no canister, "small", "medium" and "large"
- `k`: multiplication factor
- `show`: when TRUE shows row of table with respective emission factor.

Example:

```{r rlevap, echo = TRUE, fig.cap='Running losses evaporative emission actors (g/trip)', out.width='100%', fig.asp=.75, fig.align='center', warning=FALSE}
library(vein)
library(ggplot2)
library(cptcity)
dt <- c("-5_10", "0_15", "10_25", "20_35")
ef <- sapply(1:4, function(i){
  ef_evap(ef = "erhotc",v = "PC", cc = "<=1400",
                dt = dt[i], ca = "no",
                show = TRUE)
})
df <- data.frame(ef = ef, temp = c(0, 10, 20, 30))
source("theme_black.R")
ggplot(df, aes(x = temp, y = ef)) +
  geom_bar(stat = "identity", fill = cpt(n = 4), col = "white") + 
  labs(x = "Temperature[C]", y = "RL Evaporative NMHC [g/trip]") + 
  theme_black()
```


b) Alternative approach

The evaporative emission factors mentioned before are suitable for top-down estimations. That approach also requires knowledge of the 'procedure' and 'trips'. In this section it is introduced an alternative which consists in transform the emission factors into $g \cdot km^-1$ and then do a bottom-up estimation.

In order to do that, we need to follow some assumptions. First, we consider that the number of procedures is equal to trips. Then we estimate how many trips per  day are produced each day and then we estimate how many kilometers are driven each day and convert these to emission factors as shown on Eq. \@ref(eq:efev2).

\begin{equation}
EF_{ev}(\frac{g}{km})=EF(_{ev})(\frac{g}{trip}) \cdot A(\frac{trips}{day}) \cdot B(\frac{km}{day})^{-1}
(\#eq:efev2)
\end{equation}

Clearly, we need to know A $(\frac{trips}{day})$ and B$(\frac{km}{day})^{-1}$. Diurnal evaporative emissions factors are expressed as $(\frac{g}{day})$. To convert to $(\frac{g}{km})$ we only need the kilometers driven each day $\frac{km}{day}^{-1}$.

Now, it will be shown an example with the evaporative emission factors from 
-@CETESB2015. These emission factors are based on the methodology Tier 2 from 
-@@MelliosNtziachristos2016. If we consider evaporative emission factors of Passenger Cars using Gasoline (blended with 25\% of Ethanol) [@CETESB2015] and4.6 $(\frac{trips}{day})$ [@ibarrathesis].

```{r echo = FALSE}
evap <- readRDS("rds/evappc.rds")
head(evap)
```
The variable ed_20_35 are diurnal evaporative emission factors in $g \cdot day^{-1}$
and eshot_20_35 and erhot_20_35  $g \cdot trip^{-1}$.

```{r efEVAP, fig.cap='Hot Soak (blue), Diurnal (green) and Running Losses (red) EF (g/km)', out.width='100%', fig.asp=.75, fig.align='center'}

library(vein)
data(fkm)
evap$ed_20_35_gkm <- evap$ed_20_35 / fkm$KM_PC_E25(1:41)/365
evap$eshot_20_35_gkm <- evap$eshot_20_35 * 4.6/ fkm$KM_PC_E25(1:41)/365
evap$erhot_20_35_gkm <- evap$erhot_20_35  * 4.6/ fkm$KM_PC_E25(1:41)/365
plot(x = 1:41, y = evap$eshot_20_35_gkm, col = "blue", 
     type = "b", pch = 16,
     xlab = "Age of use", ylab = "EV NMHC [g/km]")
lines(x = 1:41, y = evap$ed_20_35_gkm, col = "red", 
      type = "b", pch = 15)
lines(x = 1:41, y = evap$erhot_20_35_gkm, col = "green", 
      type = "b", pch = 17)

```


## Emission factors of wear `ef_wear` 

Wear emissions are very important because they contribute with an important fraction of PM from tyre and break wear. VEIN includes these functions from -@NtziachristosBoulter2009 which include wear emission factors form tyre, break and road abrasion.

The arguments are:

```{r}
args(ef_wear)
```

- `wear`: Character; type of wear: "tyre", "break" and "road"
- `type`: Character; type of vehicle: "2W", "PC", "LCV", 'HDV"
- `pol`: Character; pollutant: "TSP", "PM10", "PM2.5", "PM1" and "PM0.1"
- `speed`: List of speeds
- `load`: Load of the HDV
- `axle`: Number of axle of the HDV

```{r eval = FALSE}
library(vein)
?ef_wear
```

## Emission factors from tunnel studies

With VEIN you can choose three type of emissions factors, speed functions, local emission factors or scaled factors. In this section I will show how to expand the use of local emission factors considering tunnel emission factors [@perez2014emission], from the International Vehicle Emissions (IVE) Model  [@Davisetal2005] applied in Colombia [@gonzalez2017relative].

-@perez2014emission measured air pollutant concentrations in two tunnels in SÃ£o Paulo city, one with predominant use of LDV vehicles and another with more HDV. The resulting emission factors for the fleet are shown on Table \@ref(tab:eftun).

```{r eftun, echo=FALSE}
df <- EmissionFactors(data.frame(CO = c(5.8, 3.6),
                 NOx = c(0.3, 9.2)))
row.names(df) <- c("LDV", "HDV")
knitr::kable(df, 
  caption = 'Emission factors from tunnels in SÃ£o Paulo 2014',
  booktabs = TRUE
)
```

If we want to compare these with the -@CETESB2015 emission factors, we would have to weight these factors with the fleet. The weight mean emission factor of CO and Passenger Cars (PC) is 1.40 $g \cdot km^{-1}$ and for Light Trucks (LT) is 0.60 $g \cdot km^{-1}$. In the case of NOx, Passenger Cars (PC) is 0.16 $g \cdot  km^{-1}$ and for Light Trucks (LT) is 3.24 $g \cdot km^{-1}$. The emission factors  from the example are for vehicles with 0 kilometers without deterioration. Anyways,  tunnel emission factors are higher that the weighted emission factors from CETESB.

```{r}
library(vein)
data(fe2015)
fecoPC <- fe2015[fe2015$Pollutant == "CO", "PC_G"]
fecoLT <- fe2015[fe2015$Pollutant == "CO", "LT"]
fenoxPC <- fe2015[fe2015$Pollutant == "NOx", "PC_G"]
fenoxLT <- fe2015[fe2015$Pollutant == "NOx", "LT"]
PC <- age_ldv(x = 1, name = "PC", agemax = 36, message = FALSE)
LT <- age_hdv(x = 1, name = "LT", agemax = 36, message = FALSE)
weighted.mean(fecoPC, PC)  # PC CO
weighted.mean(fecoLT, LT)  # LT CO
weighted.mean(fenoxPC, PC) # PC NOx 
weighted.mean(fenoxLT, LT) # LT NOx
```

If the user wants to use tunnel emission factors from -@perez2014emission in VEIN, the user would have to use the same value for all respective categories of the vehicular composition. For instance, after running `inventory`, include tunnel emission factors in each `*input.R`.

## Emission factors from International Vehicle Emissions (IVE)

The IVE model is calculates emission factors by correcting BASE emission factors with the vehicle specific power (VSP) methodology to predict
emissions [@jimenez1999vehicle]. The formula is shown on Eq. \@ref(eq:vsp).

\begin{equation}
VSP = v \cdot (1.1 \cdot a + 9.81(atan(sin(grade))) + 0.132) + 0.000302v^3
(\#eq:vsp)
\end{equation}

where:
$v$ is velocity $(m \cdot s^{-1})$, $a$ is the second by second acceleration $(m \cdot s^{-2})$ and grade the second  by second change in height defined as $\frac{(h_{t=0} - h_{t=-1})}{v}$; being  $h$ as altitude $m$. This method requires that the user measures the activity Global 
Position System (GPS) recordings second by second and/or emissions measurements with Portable Emissions Measurement Systems (PEMS).

-@gonzalez2017relative measure the vehicular activity in the city of Manizales, Colombia. In this case, there were no PEMS measurements, but IVE allows to produce emission factors from the GPS recordings based on Mobile EPA emissions model[@arbor2003user, @Davisetal2005].

The arguments are:

```{r}
args(ef_ive)
```

- `description`: Character; "Auto/Sml Truck" "Truck/Bus" or"Sml Engine".
- `fuel`: Character; "Petrol", "NG Retrofit", "Natural Gas", "Prop Retro.", "Propane", "EthOH Retrofit", "OEM Ethanol", "Diesel", "Ethanol" or "CNG/LPG".
- `weight`: Character; "Light", "Medium", "Heavy", "Lt", "Med" or "Hvy"
- `air_fuel_control`: Character; One of the following characters: "Carburetor", "Single-Pt FI", "Multi-Pt FI", "Carb/Mixer", "FI", "Pre-Chamber Inject.", "Direct Injection", "2-Cycle", "2-Cycle, FI", "4-Cycle, Carb", "4-Cycle, FI" "4-Cycle"
- `exhaust`: Character: "None", "2-Way", "2-Way/EGR", "3-Way", "3-Way/EGR", "None/EGR", "LEV", "ULEV", "SULEV", "EuroI", "EuroII", "EuroIII", "EuroIV", "Hybrid", "Improved", "EGR+Improv", "Particulate", "Particulate/NOx", "EuroV", "High Tech" or "Catalyst"
- `evaporative`: Character: "PCV", "PCV/Tank" or"None".
- `mileage`:Numeric; mileage of vehicle by age of use km.
- `pol`: Character: "VOC_gkm", "CO_gkm", "NOx_gkm", "PM_gkm", "Pb_gkm", "SO2_gkm", "NH3_gkm",  "ONE_3_butadiene_gkm", "formaldehyde_gkm", "acetaldehyde_gkm", "benzene_gkm", "EVAP_gkm", "CO2_gkm", "N20_gkm", "CH4_gkm", "VOC_gstart", "CO_gstart", "NOx_gstart", "PM_gstart", "Pb_gstart", "SO2_gstart",
"NH3_gstart", "ONE_3butadiene_gstart", "formaldehyde_gstart","acetaldehyde_gstart",
"benzene_gstart", "EVAP_gstart", "CO2_gstart", "N20_gstart", "CH4_gstart"
- `details`: Logical; option to see or not more information about vehicle.

## Emission factors from the Environmental Agency of SÃ£o Paulo

It has been mentioned that the model includes already some emission factors from the Environmental Agency of SÃ£o Paulo CETESB for year 2015. However, a new feature alredy present in VEIN is incorporation of all CETESB emission factors for 2016 [@CETESB2016].



```{r}
args(ef_cetesb)
```

- `p`:    Character; Pollutants: "COd", "HCd", "NMHCd", "CH4", "NOxd", "CO2" "PM", "N2O", "KML", "FC", "NO2d", "NOd", "gD/KWH", "gCO2/KWH", "RCHOd", "CO", "HC", "NMHC", "NOx", "NO2" ,"NO", "RCHO" (g/km). The letter 'd' means deteriorated factor. Also, evaporative emissions at average temperature ranges: "D_20_35", "S_20_35", "R_20_35", "D_10_25", "S_10_25", "R_10_25", "D_0_15" "S_0_15" and "R_0_15" where D means diurnal (g/day), S hot/warm soak (g/trip) and R hot/warm running losses (g/trip).
- `veh`:    Character; Vehicle categories: "PC_G", "PC_FG", "PC_FE", "PC_E" "LCV_G", "LCV_FG", "LCV_FE", "LCV_E", "LCV_D", "SLT", "LT", "MT", "SHT" "HT", "UB", "SUB", "COACH", "ARTIC", "M_G_150", "M_G_150_500", "M_G_500" "M_FG_150", "M_FG_150_500", "M_FG_500". "M_FE_150", "M_FE_150_500", "M_FE_500", "CICLOMOTOR", "GNV
full    
- `Logical`; To return a data.frame instead or a vector adding Age, Year, Brazilian emissions standards and its euro equivalents.

The letter 'd' means deteriorated factor. I added the pollutants "NO", "NO2" based  on the speciation of the -@NtziachristosSamaras2016 guidelines. 

I also added the categiry "ARTIC" for articulated buses, based on the proportion of Articulated buses to standard urban buses on -@NtziachristosSamaras2016 guidelines, which is apporximatly 1.4 times the standard emission factor.

